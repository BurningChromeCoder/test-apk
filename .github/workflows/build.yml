name: Build APK con FCM - Notificaciones en Background y Firma

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
    
    - name: Setup Java 21
      uses: actions/setup-java@v4
      with:
        distribution: 'temurin'
        java-version: '21'
    
    - name: Install Dependencies
      run: npm install

    - name: Build Web Assets
      run: npm run build
      
    - name: Add Android platform
      run: npx cap add android || true

    - name: Create All Native Plugins and Services
      run: |
        mkdir -p android/app/src/main/java/com/mipuerta/app
        
        cat > android/app/src/main/java/com/mipuerta/app/WakeLockPlugin.java << 'WAKEOF'
        package com.mipuerta.app;
        import android.app.Activity;
        import android.content.Context;
        import android.os.PowerManager;
        import android.view.WindowManager;
        import com.getcapacitor.Plugin;
        import com.getcapacitor.PluginCall;
        import com.getcapacitor.PluginMethod;
        import com.getcapacitor.annotation.CapacitorPlugin;
        @CapacitorPlugin(name = "WakeLock")
        public class WakeLockPlugin extends Plugin {
            @PluginMethod
            public void acquire(PluginCall call) {
                Activity activity = getActivity();
                activity.runOnUiThread(() -> {
                    try {
                        PowerManager pm = (PowerManager) activity.getSystemService(Context.POWER_SERVICE);
                        PowerManager.WakeLock wl = pm.newWakeLock(PowerManager.FULL_WAKE_LOCK | PowerManager.ACQUIRE_CAUSES_WAKEUP, "MiPuerta:Wake");
                        wl.acquire(10000);
                        activity.getWindow().addFlags(WindowManager.LayoutParams.FLAG_SHOW_WHEN_LOCKED | WindowManager.LayoutParams.FLAG_TURN_SCREEN_ON | WindowManager.LayoutParams.FLAG_KEEP_SCREEN_ON);
                        call.resolve();
                    } catch (Exception e) { call.reject(e.getMessage()); }
                });
            }
            @PluginMethod
            public void release(PluginCall call) {
                Activity activity = getActivity();
                activity.runOnUiThread(() -> {
                    try {
                        activity.getWindow().clearFlags(WindowManager.LayoutParams.FLAG_SHOW_WHEN_LOCKED | WindowManager.LayoutParams.FLAG_TURN_SCREEN_ON | WindowManager.LayoutParams.FLAG_KEEP_SCREEN_ON);
                        call.resolve();
                    } catch (Exception e) { call.reject(e.getMessage()); }
                });
            }
        }
        WAKEOF
        
        cat > android/app/src/main/java/com/mipuerta/app/CallPlugin.java << 'CALLEOF'
        package com.mipuerta.app;
        import android.Manifest;
        import android.app.Activity;
        import android.app.NotificationChannel;
        import android.app.NotificationManager;
        import android.app.PendingIntent;
        import android.content.Context;
        import android.content.Intent;
        import android.media.AudioAttributes;
        import android.media.Ringtone;
        import android.media.RingtoneManager;
        import android.net.Uri;
        import android.os.Build;
        import android.os.PowerManager;
        import android.os.VibrationEffect;
        import android.os.Vibrator;
        import android.view.WindowManager;
        import androidx.core.app.NotificationCompat;
        import com.getcapacitor.Plugin;
        import com.getcapacitor.PluginCall;
        import com.getcapacitor.PluginMethod;
        import com.getcapacitor.annotation.CapacitorPlugin;
        import com.getcapacitor.annotation.Permission;

        @CapacitorPlugin(name = "CallPlugin", permissions = {
            @Permission(alias = "audio", strings = {Manifest.permission.RECORD_AUDIO, Manifest.permission.MODIFY_AUDIO_SETTINGS}),
            @Permission(alias = "phone", strings = {Manifest.permission.READ_PHONE_STATE, Manifest.permission.CALL_PHONE}),
            @Permission(alias = "vibrate", strings = {Manifest.permission.VIBRATE})
        })
        public class CallPlugin extends Plugin {
            private Ringtone currentRingtone;
            private Vibrator vibrator;

            @PluginMethod
            public void requestBatteryOptimization(PluginCall call) {
                Context context = getContext();
                if (Build.VERSION.SDK_INT >= Build.VERSION_CODES.M) {
                    Intent intent = new Intent();
                    String packageName = context.getPackageName();
                    PowerManager pm = (PowerManager) context.getSystemService(Context.POWER_SERVICE);
                    if (!pm.isIgnoringBatteryOptimizations(packageName)) {
                        intent.setAction(android.provider.Settings.ACTION_REQUEST_IGNORE_BATTERY_OPTIMIZATIONS);
                        intent.setData(Uri.parse("package:" + packageName));
                        intent.setFlags(Intent.FLAG_ACTIVITY_NEW_TASK);
                        context.startActivity(intent);
                        call.resolve();
                    } else {
                        call.resolve();
                    }
                } else {
                    call.resolve();
                }
            }

            @PluginMethod
            public void exitApp(PluginCall call) {
                Activity activity = getActivity();
                activity.runOnUiThread(() -> {
                    activity.moveTaskToBack(true);
                    call.resolve();
                });
            }

            @PluginMethod
            public void showIncomingCall(PluginCall call) {
                String ringtoneType = call.getString("ringtoneType", "TYPE_RINGTONE");
                Activity activity = getActivity();
                vibrator = (Vibrator) activity.getSystemService(Context.VIBRATOR_SERVICE);

                activity.runOnUiThread(() -> {
                    try {
                        PowerManager pm = (PowerManager) activity.getSystemService(Context.POWER_SERVICE);
                        PowerManager.WakeLock wl = pm.newWakeLock(PowerManager.FULL_WAKE_LOCK | PowerManager.ACQUIRE_CAUSES_WAKEUP, "MiPuerta:FastWake");
                        wl.acquire(20000);
                        activity.getWindow().addFlags(WindowManager.LayoutParams.FLAG_SHOW_WHEN_LOCKED | WindowManager.LayoutParams.FLAG_TURN_SCREEN_ON | WindowManager.LayoutParams.FLAG_DISMISS_KEYGUARD | WindowManager.LayoutParams.FLAG_KEEP_SCREEN_ON);

                        if (currentRingtone != null) currentRingtone.stop();
                        int type = "TYPE_ALARM".equals(ringtoneType) ? RingtoneManager.TYPE_ALARM : RingtoneManager.TYPE_RINGTONE;
                        Uri uri = RingtoneManager.getDefaultUri(type);
                        currentRingtone = RingtoneManager.getRingtone(activity, uri);
                        if (currentRingtone != null) {
                            if (Build.VERSION.SDK_INT >= Build.VERSION_CODES.LOLLIPOP) {
                                currentRingtone.setAudioAttributes(new AudioAttributes.Builder().setUsage(AudioAttributes.USAGE_ALARM).build());
                            }
                            currentRingtone.play();
                        }

                        if (vibrator != null) {
                            long[] pattern = {0, 800, 200, 800, 200, 800};
                            if (Build.VERSION.SDK_INT >= Build.VERSION_CODES.O) {
                                vibrator.vibrate(VibrationEffect.createWaveform(pattern, 0));
                            } else {
                                vibrator.vibrate(pattern, 0);
                            }
                        }

                        NotificationManager nm = (NotificationManager) activity.getSystemService(Context.NOTIFICATION_SERVICE);
                        if (Build.VERSION.SDK_INT >= Build.VERSION_CODES.O) {
                            NotificationChannel channel = new NotificationChannel("urgent_calls", "Llamadas Urgentes", NotificationManager.IMPORTANCE_HIGH);
                            channel.setBypassDnd(true);
                            channel.setLockscreenVisibility(android.app.Notification.VISIBILITY_PUBLIC);
                            nm.createNotificationChannel(channel);
                        }

                        Intent intent = new Intent(activity, activity.getClass());
                        intent.addFlags(Intent.FLAG_ACTIVITY_NEW_TASK | Intent.FLAG_ACTIVITY_SINGLE_TOP);
                        PendingIntent pi = PendingIntent.getActivity(activity, 0, intent, PendingIntent.FLAG_UPDATE_CURRENT | PendingIntent.FLAG_IMMUTABLE);

                        NotificationCompat.Builder builder = new NotificationCompat.Builder(activity, "urgent_calls")
                            .setSmallIcon(android.R.drawable.ic_menu_call)
                            .setContentTitle("ðŸš¨ Â¡ALGUIEN EN LA PUERTA!")
                            .setContentText("Toca para contestar")
                            .setPriority(NotificationCompat.PRIORITY_MAX)
                            .setCategory(NotificationCompat.CATEGORY_CALL)
                            .setFullScreenIntent(pi, true)
                            .setVisibility(NotificationCompat.VISIBILITY_PUBLIC)
                            .setOngoing(true);

                        nm.notify(999, builder.build());
                        call.resolve();
                    } catch (Exception e) { call.reject(e.getMessage()); }
                });
            }

            @PluginMethod
            public void endCall(PluginCall call) {
                if (currentRingtone != null) currentRingtone.stop();
                if (vibrator != null) vibrator.cancel();
                NotificationManager nm = (NotificationManager) getContext().getSystemService(Context.NOTIFICATION_SERVICE);
                nm.cancel(999);
                call.resolve();
            }
            
            @PluginMethod
            public void vibrate(PluginCall call) {
                vibrator = (Vibrator) getContext().getSystemService(Context.VIBRATOR_SERVICE);
                if (vibrator != null) {
                    if (Build.VERSION.SDK_INT >= Build.VERSION_CODES.O) {
                        vibrator.vibrate(VibrationEffect.createOneShot(200, VibrationEffect.DEFAULT_AMPLITUDE));
                    } else {
                        vibrator.vibrate(200);
                    }
                }
                call.resolve();
            }
        }
        CALLEOF
        
        cat > android/app/src/main/java/com/mipuerta/app/MyFirebaseMessagingService.java << 'FCMEOF'
        package com.mipuerta.app;
        import android.app.NotificationChannel;
        import android.app.NotificationManager;
        import android.app.PendingIntent;
        import android.content.Context;
        import android.content.Intent;
        import android.media.AudioAttributes;
        import android.media.Ringtone;
        import android.media.RingtoneManager;
        import android.net.Uri;
        import android.os.Build;
        import android.os.PowerManager;
        import android.os.VibrationEffect;
        import android.os.Vibrator;
        import android.util.Log;
        import androidx.core.app.NotificationCompat;
        import com.google.firebase.messaging.FirebaseMessagingService;
        import com.google.firebase.messaging.RemoteMessage;
        import java.util.Map;

        public class MyFirebaseMessagingService extends FirebaseMessagingService {
            private static final String TAG = "FCMService";
            private static final String CHANNEL_ID = "incoming_calls";
            private static final int NOTIFICATION_ID = 1001;
            private Ringtone ringtone;
            private Vibrator vibrator;

            @Override
            public void onMessageReceived(RemoteMessage remoteMessage) {
                Log.d(TAG, "FCM Message from: " + remoteMessage.getFrom());
                if (remoteMessage.getData().size() > 0) {
                    Map<String, String> data = remoteMessage.getData();
                    String type = data.get("type");
                    if ("incoming_call".equals(type)) {
                        Log.d(TAG, "LLAMADA ENTRANTE - Despertando app");
                        handleIncomingCall(data);
                    } else if ("end_call".equals(type)) {
                        stopRingtoneAndVibration();
                    }
                }
            }

            @Override
            public void onNewToken(String token) {
                Log.d(TAG, "FCM token: " + token);
            }

            private void handleIncomingCall(Map<String, String> data) {
                String llamadaId = data.get("llamadaId");
                String callerName = data.getOrDefault("callerName", "Visitante");
                wakeUpScreen();
                playRingtone();
                startVibration();
                showFullScreenNotification(callerName, llamadaId);
                launchApp(llamadaId);
            }

            private void wakeUpScreen() {
                try {
                    PowerManager pm = (PowerManager) getSystemService(Context.POWER_SERVICE);
                    PowerManager.WakeLock wl = pm.newWakeLock(PowerManager.FULL_WAKE_LOCK | PowerManager.ACQUIRE_CAUSES_WAKEUP, "MiPuerta:Call");
                    wl.acquire(30000);
                } catch (Exception e) { Log.e(TAG, "Error wakeup: " + e.getMessage()); }
            }

            private void playRingtone() {
                try {
                    if (ringtone != null && ringtone.isPlaying()) ringtone.stop();
                    Uri uri = RingtoneManager.getDefaultUri(RingtoneManager.TYPE_RINGTONE);
                    ringtone = RingtoneManager.getRingtone(getApplicationContext(), uri);
                    if (ringtone != null) {
                        if (Build.VERSION.SDK_INT >= Build.VERSION_CODES.LOLLIPOP) {
                            ringtone.setAudioAttributes(new AudioAttributes.Builder().setUsage(AudioAttributes.USAGE_ALARM).build());
                        }
                        ringtone.play();
                    }
                } catch (Exception e) { Log.e(TAG, "Error ringtone: " + e.getMessage()); }
            }

            private void startVibration() {
                try {
                    vibrator = (Vibrator) getSystemService(Context.VIBRATOR_SERVICE);
                    if (vibrator != null) {
                        long[] pattern = {0, 1000, 500, 1000, 500, 1000};
                        if (Build.VERSION.SDK_INT >= Build.VERSION_CODES.O) {
                            vibrator.vibrate(VibrationEffect.createWaveform(pattern, 0));
                        } else {
                            vibrator.vibrate(pattern, 0);
                        }
                    }
                } catch (Exception e) { Log.e(TAG, "Error vibrate: " + e.getMessage()); }
            }

            private void showFullScreenNotification(String callerName, String llamadaId) {
                try {
                    NotificationManager nm = (NotificationManager) getSystemService(Context.NOTIFICATION_SERVICE);
                    if (Build.VERSION.SDK_INT >= Build.VERSION_CODES.O) {
                        NotificationChannel channel = new NotificationChannel(CHANNEL_ID, "Llamadas", NotificationManager.IMPORTANCE_HIGH);
                        channel.setLockscreenVisibility(android.app.Notification.VISIBILITY_PUBLIC);
                        nm.createNotificationChannel(channel);
                    }
                    Intent intent = new Intent(this, MainActivity.class);
                    intent.setFlags(Intent.FLAG_ACTIVITY_NEW_TASK | Intent.FLAG_ACTIVITY_CLEAR_TOP);
                    intent.putExtra("llamadaId", llamadaId);
                    PendingIntent pi = PendingIntent.getActivity(this, 0, intent, PendingIntent.FLAG_UPDATE_CURRENT | PendingIntent.FLAG_IMMUTABLE);
                    NotificationCompat.Builder builder = new NotificationCompat.Builder(this, CHANNEL_ID)
                        .setSmallIcon(android.R.drawable.ic_menu_call)
                        .setContentTitle("Â¡ALGUIEN EN LA PUERTA!")
                        .setContentText(callerName)
                        .setPriority(NotificationCompat.PRIORITY_MAX)
                        .setCategory(NotificationCompat.CATEGORY_CALL)
                        .setFullScreenIntent(pi, true)
                        .setOngoing(true);
                    nm.notify(NOTIFICATION_ID, builder.build());
                } catch (Exception e) { Log.e(TAG, "Error notification: " + e.getMessage()); }
            }

            private void launchApp(String llamadaId) {
                try {
                    Intent intent = new Intent(this, MainActivity.class);
                    intent.addFlags(Intent.FLAG_ACTIVITY_NEW_TASK | Intent.FLAG_ACTIVITY_CLEAR_TOP);
                    intent.putExtra("llamadaId", llamadaId);
                    startActivity(intent);
                } catch (Exception e) { Log.e(TAG, "Error launch: " + e.getMessage()); }
            }

            private void stopRingtoneAndVibration() {
                try {
                    if (ringtone != null && ringtone.isPlaying()) ringtone.stop();
                    if (vibrator != null) vibrator.cancel();
                    NotificationManager nm = (NotificationManager) getSystemService(Context.NOTIFICATION_SERVICE);
                    nm.cancel(NOTIFICATION_ID);
                } catch (Exception e) { Log.e(TAG, "Error stop: " + e.getMessage()); }
            }

            @Override
            public void onDestroy() {
                super.onDestroy();
                stopRingtoneAndVibration();
            }
        }
        FCMEOF
        
        cat > android/app/src/main/java/com/mipuerta/app/CallActionReceiver.java << 'RECEIVEROF'
        package com.mipuerta.app;
        import android.content.BroadcastReceiver;
        import android.content.Context;
        import android.content.Intent;
        import android.util.Log;

        public class CallActionReceiver extends BroadcastReceiver {
            @Override
            public void onReceive(Context context, Intent intent) {
                String action = intent.getAction();
                String llamadaId = intent.getStringExtra("llamadaId");
                Log.d("CallActionReceiver", "Action: " + action);
                if ("ANSWER_CALL".equals(action)) {
                    Intent launchIntent = new Intent(context, MainActivity.class);
                    launchIntent.addFlags(Intent.FLAG_ACTIVITY_NEW_TASK | Intent.FLAG_ACTIVITY_CLEAR_TOP);
                    launchIntent.putExtra("llamadaId", llamadaId);
                    launchIntent.putExtra("action", "answer");
                    context.startActivity(launchIntent);
                } else if ("REJECT_CALL".equals(action)) {
                    Intent broadcast = new Intent("com.mipuerta.app.REJECT_CALL");
                    broadcast.putExtra("llamadaId", llamadaId);
                    context.sendBroadcast(broadcast);
                }
            }
        }
        RECEIVEROF
        
        cat > android/app/src/main/java/com/mipuerta/app/MainActivity.java << 'MAINEOF'
        package com.mipuerta.app;
        import android.os.Bundle;
        import com.getcapacitor.BridgeActivity;
        public class MainActivity extends BridgeActivity {
            @Override
            public void onCreate(Bundle savedInstanceState) {
                registerPlugin(WakeLockPlugin.class);
                registerPlugin(CallPlugin.class);
                super.onCreate(savedInstanceState);
            }
        }
        MAINEOF

    - name: Configure AndroidManifest with FCM
      run: |
        MANIFEST="android/app/src/main/AndroidManifest.xml"
        PERMISSIONS='<uses-permission android:name="android.permission.INTERNET" /><uses-permission android:name="android.permission.WAKE_LOCK" /><uses-permission android:name="android.permission.VIBRATE" /><uses-permission android:name="android.permission.RECORD_AUDIO" /><uses-permission android:name="android.permission.MODIFY_AUDIO_SETTINGS" /><uses-permission android:name="android.permission.USE_FULL_SCREEN_INTENT" /><uses-permission android:name="android.permission.DISABLE_KEYGUARD" /><uses-permission android:name="android.permission.SYSTEM_ALERT_WINDOW" /><uses-permission android:name="android.permission.READ_PHONE_STATE" /><uses-permission android:name="android.permission.CALL_PHONE" /><uses-permission android:name="android.permission.REQUEST_IGNORE_BATTERY_OPTIMIZATIONS" /><uses-permission android:name="android.permission.POST_NOTIFICATIONS" />'
        sed -i "s|<application|$PERMISSIONS<application|g" $MANIFEST
        sed -i 's|<activity.*|<activity android:name=".MainActivity" android:configChanges="orientation\|keyboardHidden\|keyboard\|screenSize\|locale\|smallestScreenSize\|screenLayout\|uiMode" android:label="@string/title_activity_main" android:launchMode="singleInstance" android:showWhenLocked="true" android:turnScreenOn="true" android:theme="@style/AppTheme.NoActionBarLaunch" android:exported="true">|' $MANIFEST
        sed -i 's|</application>|<service android:name=".MyFirebaseMessagingService" android:exported="false"><intent-filter><action android:name="com.google.firebase.MESSAGING_EVENT" /></intent-filter></service><receiver android:name=".CallActionReceiver" android:exported="false" /></application>|' $MANIFEST

    - name: Inject Firebase Dependencies into build.gradle
      run: |
        GRADLE="android/app/build.gradle"
        sed -i "/dependencies {/a \    implementation 'com.google.firebase:firebase-messaging:23.4.0'" $GRADLE
        sed -i "/dependencies {/a \    implementation platform('com.google.firebase:firebase-bom:32.7.0')" $GRADLE

    - name: Create google-services.json
      run: echo '${{ secrets.GOOGLE_SERVICES_JSON }}' > android/app/google-services.json

    - name: Sync Capacitor
      run: npx cap sync
    
    - name: Grant execute permission
      run: chmod +x android/gradlew
        
    - name: Build Release APK
      run: |
        cd android
        ./gradlew assembleRelease --no-daemon
    
    # ===== NUEVA ACCIÃ“N DE FIRMA =====
    - name: Sign Android Release
      uses: ilharp/sign-android-release@v1
      id: sign_app
      with:
        releaseDir: android/app/build/outputs/apk/release
        signingKey: ${{ secrets.ANDROID_KEYSTORE_BASE64 }}
        keyAlias: ${{ secrets.ANDROID_KEY_ALIAS }}
        keyStorePassword: ${{ secrets.ANDROID_KEYSTORE_PASSWORD }}
        keyPassword: ${{ secrets.ANDROID_KEY_PASSWORD }}

    - name: Upload Signed APK
      uses: actions/upload-artifact@v4
      with:
        name: MiPuerta-Release-Signed
        path: ${{ steps.sign_app.outputs.signedFile }}
