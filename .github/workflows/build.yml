name: Build APK Completo - SoluciÃ³n Final

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
    
    - name: Setup Java 21
      uses: actions/setup-java@v4
      with:
        distribution: 'temurin'
        java-version: '21'
    
    - name: Install Dependencies
      run: npm install

    - name: Build Web Assets
      run: npm run build
      
    - name: Add Android platform
      run: npx cap add android || true

    - name: Create All Native Plugins
      run: |
        mkdir -p android/app/src/main/java/com/mipuerta/app
        
        cat > android/app/src/main/java/com/mipuerta/app/WakeLockPlugin.java << 'WAKEOF'
        package com.mipuerta.app;
        import android.app.Activity;
        import android.content.Context;
        import android.content.Intent;
        import android.os.Build;
        import android.os.PowerManager;
        import android.view.WindowManager;
        import com.getcapacitor.JSObject;
        import com.getcapacitor.Plugin;
        import com.getcapacitor.PluginCall;
        import com.getcapacitor.PluginMethod;
        import com.getcapacitor.annotation.CapacitorPlugin;
        @CapacitorPlugin(name = "WakeLock")
        public class WakeLockPlugin extends Plugin {
            private PowerManager.WakeLock wakeLock;
            @PluginMethod
            public void acquire(PluginCall call) {
                Activity activity = getActivity();
                if (activity == null) {
                    call.reject("Activity not available");
                    return;
                }
                activity.runOnUiThread(() -> {
                    try {
                        PowerManager powerManager = (PowerManager) activity.getSystemService(Context.POWER_SERVICE);
                        if (wakeLock == null) {
                            wakeLock = powerManager.newWakeLock(
                                PowerManager.SCREEN_BRIGHT_WAKE_LOCK | 
                                PowerManager.ACQUIRE_CAUSES_WAKEUP |
                                PowerManager.ON_AFTER_RELEASE,
                                "MiPuerta::WakeLock"
                            );
                            wakeLock.setReferenceCounted(false);
                        }
                        if (!wakeLock.isHeld()) {
                            wakeLock.acquire(10 * 60 * 1000L);
                        }
                        if (Build.VERSION.SDK_INT >= Build.VERSION_CODES.O_MR1) {
                            activity.setShowWhenLocked(true);
                            activity.setTurnScreenOn(true);
                        } else {
                            activity.getWindow().addFlags(
                                WindowManager.LayoutParams.FLAG_SHOW_WHEN_LOCKED |
                                WindowManager.LayoutParams.FLAG_TURN_SCREEN_ON |
                                WindowManager.LayoutParams.FLAG_KEEP_SCREEN_ON
                            );
                        }
                        Intent intent = new Intent(activity, activity.getClass());
                        intent.addFlags(Intent.FLAG_ACTIVITY_NEW_TASK | Intent.FLAG_ACTIVITY_SINGLE_TOP);
                        activity.startActivity(intent);
                        JSObject ret = new JSObject();
                        ret.put("success", true);
                        call.resolve(ret);
                    } catch (Exception e) {
                        call.reject("Error: " + e.getMessage());
                    }
                });
            }
            @PluginMethod
            public void release(PluginCall call) {
                if (wakeLock != null && wakeLock.isHeld()) {
                    wakeLock.release();
                }
                JSObject ret = new JSObject();
                ret.put("success", true);
                call.resolve(ret);
            }
        }
        WAKEOF
        
        cat > android/app/src/main/java/com/mipuerta/app/CallConnectionService.java << 'CONNEOF'
        package com.mipuerta.app;
        import android.net.Uri;
        import android.telecom.Connection;
        import android.telecom.ConnectionRequest;
        import android.telecom.ConnectionService;
        import android.telecom.PhoneAccountHandle;
        import android.telecom.TelecomManager;
        import android.telecom.DisconnectCause;
        import android.util.Log;
        public class CallConnectionService extends ConnectionService {
            private static final String TAG = "CallConnectionService";
            private static CallConnection activeConnection;
            @Override
            public Connection onCreateOutgoingConnection(PhoneAccountHandle connectionManagerPhoneAccount, ConnectionRequest request) {
                return null;
            }
            @Override
            public Connection onCreateIncomingConnection(PhoneAccountHandle connectionManagerPhoneAccount, ConnectionRequest request) {
                Log.d(TAG, "onCreateIncomingConnection");
                activeConnection = new CallConnection();
                activeConnection.setConnectionCapabilities(Connection.CAPABILITY_HOLD | Connection.CAPABILITY_SUPPORT_HOLD | Connection.CAPABILITY_MUTE);
                activeConnection.setAddress(Uri.parse("tel:Visitante"), TelecomManager.PRESENTATION_ALLOWED);
                activeConnection.setCallerDisplayName("ðŸ”” Timbre Puerta", TelecomManager.PRESENTATION_ALLOWED);
                activeConnection.setRinging();
                return activeConnection;
            }
            public static void endCall() {
                if (activeConnection != null) {
                    activeConnection.setDisconnected(new DisconnectCause(DisconnectCause.LOCAL));
                    activeConnection.destroy();
                    activeConnection = null;
                }
            }
            public static void answerCall() {
                if (activeConnection != null) {
                    activeConnection.setActive();
                }
            }
            private static class CallConnection extends Connection {
                @Override
                public void onAnswer() {
                    setActive();
                    CallPlugin.notifyCallAnswered();
                }
                @Override
                public void onReject() {
                    setDisconnected(new DisconnectCause(DisconnectCause.REJECTED));
                    destroy();
                    CallPlugin.notifyCallRejected();
                }
                @Override
                public void onDisconnect() {
                    setDisconnected(new DisconnectCause(DisconnectCause.LOCAL));
                    destroy();
                }
            }
        }
        CONNEOF
        
        cat > android/app/src/main/java/com/mipuerta/app/CallPlugin.java << 'CALLEOF'
        package com.mipuerta.app;
        import android.Manifest;
        import android.app.Activity;
        import android.app.NotificationChannel;
        import android.app.NotificationManager;
        import android.app.PendingIntent;
        import android.content.ComponentName;
        import android.content.Context;
        import android.content.Intent;
        import android.content.pm.PackageManager;
        import android.os.Build;
        import android.os.Bundle;
        import android.os.VibrationEffect;
        import android.os.Vibrator;
        import android.telecom.PhoneAccount;
        import android.telecom.PhoneAccountHandle;
        import android.telecom.TelecomManager;
        import android.util.Log;
        import androidx.core.app.NotificationCompat;
        import androidx.core.content.ContextCompat;
        import com.getcapacitor.JSObject;
        import com.getcapacitor.Plugin;
        import com.getcapacitor.PluginCall;
        import com.getcapacitor.PluginMethod;
        import com.getcapacitor.annotation.CapacitorPlugin;
        import com.getcapacitor.annotation.Permission;
        @CapacitorPlugin(name = "CallPlugin", permissions = {@Permission(strings = {Manifest.permission.READ_PHONE_STATE, Manifest.permission.CALL_PHONE, Manifest.permission.MANAGE_OWN_CALLS, Manifest.permission.VIBRATE})})
        public class CallPlugin extends Plugin {
            private static final String TAG = "CallPlugin";
            private static CallPlugin instance;
            private TelecomManager telecomManager;
            private PhoneAccountHandle phoneAccountHandle;
            @Override
            public void load() {
                super.load();
                instance = this;
                Activity activity = getActivity();
                telecomManager = (TelecomManager) activity.getSystemService(Context.TELECOM_SERVICE);
                registerPhoneAccount();
                createNotificationChannel();
            }
            private void registerPhoneAccount() {
                Activity activity = getActivity();
                ComponentName componentName = new ComponentName(activity, CallConnectionService.class);
                phoneAccountHandle = new PhoneAccountHandle(componentName, "MiPuertaAccount");
                PhoneAccount phoneAccount = PhoneAccount.builder(phoneAccountHandle, "MiPuerta").setCapabilities(PhoneAccount.CAPABILITY_CALL_PROVIDER).setHighlightColor(0xFF2ECC71).setShortDescription("Timbre MiPuerta").setSupportedUriSchemes(java.util.Arrays.asList("tel")).build();
                telecomManager.registerPhoneAccount(phoneAccount);
                Log.d(TAG, "PhoneAccount registrada");
            }
            private void createNotificationChannel() {
                if (Build.VERSION.SDK_INT >= Build.VERSION_CODES.O) {
                    Activity activity = getActivity();
                    NotificationChannel channel = new NotificationChannel("incoming_calls", "Llamadas Entrantes", NotificationManager.IMPORTANCE_HIGH);
                    channel.setDescription("Notificaciones de timbre");
                    channel.enableVibration(true);
                    channel.setVibrationPattern(new long[]{0, 1000, 500, 1000});
                    NotificationManager nm = (NotificationManager) activity.getSystemService(Context.NOTIFICATION_SERVICE);
                    nm.createNotificationChannel(channel);
                }
            }
            @PluginMethod
            public void checkPermissions(PluginCall call) {
                Activity activity = getActivity();
                boolean hasReadPhone = ContextCompat.checkSelfPermission(activity, Manifest.permission.READ_PHONE_STATE) == PackageManager.PERMISSION_GRANTED;
                boolean hasCallPhone = ContextCompat.checkSelfPermission(activity, Manifest.permission.CALL_PHONE) == PackageManager.PERMISSION_GRANTED;
                boolean hasManageOwnCalls = true;
                if (Build.VERSION.SDK_INT >= Build.VERSION_CODES.O) {
                    hasManageOwnCalls = ContextCompat.checkSelfPermission(activity, Manifest.permission.MANAGE_OWN_CALLS) == PackageManager.PERMISSION_GRANTED;
                }
                boolean hasVibrate = ContextCompat.checkSelfPermission(activity, Manifest.permission.VIBRATE) == PackageManager.PERMISSION_GRANTED;
                JSObject ret = new JSObject();
                ret.put("allGranted", hasReadPhone && hasCallPhone && hasManageOwnCalls && hasVibrate);
                call.resolve(ret);
            }
            @PluginMethod
            public void requestPermissions(PluginCall call) {
                if (Build.VERSION.SDK_INT >= Build.VERSION_CODES.M) {
                    String[] permissions = Build.VERSION.SDK_INT >= Build.VERSION_CODES.O ? new String[]{Manifest.permission.READ_PHONE_STATE, Manifest.permission.CALL_PHONE, Manifest.permission.MANAGE_OWN_CALLS, Manifest.permission.VIBRATE} : new String[]{Manifest.permission.READ_PHONE_STATE, Manifest.permission.CALL_PHONE, Manifest.permission.VIBRATE};
                    requestPermissionForAliases(permissions, call, "permissionsCallback");
                } else {
                    JSObject ret = new JSObject();
                    ret.put("granted", true);
                    call.resolve(ret);
                }
            }
            @PluginMethod
            public void vibrate(PluginCall call) {
                Activity activity = getActivity();
                Vibrator vibrator = (Vibrator) activity.getSystemService(Context.VIBRATOR_SERVICE);
                if (vibrator != null && vibrator.hasVibrator()) {
                    if (Build.VERSION.SDK_INT >= Build.VERSION_CODES.O) {
                        vibrator.vibrate(VibrationEffect.createWaveform(new long[]{0, 500, 200, 500, 200, 500}, -1));
                    } else {
                        vibrator.vibrate(new long[]{0, 500, 200, 500, 200, 500}, -1);
                    }
                    Log.d(TAG, "âœ… VibraciÃ³n ejecutada");
                }
                JSObject ret = new JSObject();
                ret.put("success", true);
                call.resolve(ret);
            }
            @PluginMethod
            public void showIncomingCall(PluginCall call) {
                Activity activity = getActivity();
                if (Build.VERSION.SDK_INT < Build.VERSION_CODES.M) {
                    call.reject("API 23+ requerida");
                    return;
                }
                try {
                    Bundle extras = new Bundle();
                    extras.putString("caller_name", "ðŸ”” Visitante en Puerta");
                    telecomManager.addNewIncomingCall(phoneAccountHandle, extras);
                    if (Build.VERSION.SDK_INT >= Build.VERSION_CODES.Q) {
                        Intent fullScreenIntent = new Intent(activity, activity.getClass());
                        fullScreenIntent.setFlags(Intent.FLAG_ACTIVITY_NEW_TASK | Intent.FLAG_ACTIVITY_CLEAR_TASK);
                        PendingIntent fullScreenPendingIntent = PendingIntent.getActivity(activity, 0, fullScreenIntent, PendingIntent.FLAG_UPDATE_CURRENT | PendingIntent.FLAG_IMMUTABLE);
                        NotificationCompat.Builder builder = new NotificationCompat.Builder(activity, "incoming_calls").setSmallIcon(android.R.drawable.sym_action_call).setContentTitle("ðŸ”” Timbre").setContentText("Alguien estÃ¡ en la puerta").setPriority(NotificationCompat.PRIORITY_MAX).setCategory(NotificationCompat.CATEGORY_CALL).setFullScreenIntent(fullScreenPendingIntent, true).setAutoCancel(true);
                        NotificationManager nm = (NotificationManager) activity.getSystemService(Context.NOTIFICATION_SERVICE);
                        nm.notify(1, builder.build());
                    }
                    vibrate(call);
                    Log.d(TAG, "Llamada nativa mostrada");
                    JSObject ret = new JSObject();
                    ret.put("success", true);
                    call.resolve(ret);
                } catch (Exception e) {
                    Log.e(TAG, "Error: " + e.getMessage());
                    call.reject("Error: " + e.getMessage());
                }
            }
            @PluginMethod
            public void endCall(PluginCall call) {
                CallConnectionService.endCall();
                JSObject ret = new JSObject();
                ret.put("success", true);
                call.resolve(ret);
            }
            public static void notifyCallAnswered() {
                if (instance != null) {
                    JSObject data = new JSObject();
                    data.put("action", "answered");
                    instance.notifyListeners("callStateChanged", data);
                }
            }
            public static void notifyCallRejected() {
                if (instance != null) {
                    JSObject data = new JSObject();
                    data.put("action", "rejected");
                    instance.notifyListeners("callStateChanged", data);
                }
            }
        }
        CALLEOF
        
        cat > android/app/src/main/java/com/mipuerta/app/MainActivity.java << 'MAINEOF'
        package com.mipuerta.app;
        import android.os.Bundle;
        import com.getcapacitor.BridgeActivity;
        public class MainActivity extends BridgeActivity {
            @Override
            public void onCreate(Bundle savedInstanceState) {
                // 1. PRIMERO: Registramos los plugins para que Capacitor sepa que existen
                registerPlugin(WakeLockPlugin.class);
                registerPlugin(CallPlugin.class);
                
                // 2. DESPUÃ‰S: Arrancamos Capacitor (super.onCreate)
                super.onCreate(savedInstanceState);
            }
        }
        MAINEOF
        
        echo "âœ… Todos los archivos Java creados"

    - name: Configure AndroidManifest
      run: |
        MANIFEST="android/app/src/main/AndroidManifest.xml"
        PERMISSIONS='<uses-permission android:name="android.permission.INTERNET" /><uses-permission android:name="android.permission.CAMERA" /><uses-permission android:name="android.permission.RECORD_AUDIO" /><uses-permission android:name="android.permission.MODIFY_AUDIO_SETTINGS" /><uses-permission android:name="android.permission.USE_FULL_SCREEN_INTENT" /><uses-permission android:name="android.permission.WAKE_LOCK" /><uses-permission android:name="android.permission.FOREGROUND_SERVICE" /><uses-permission android:name="android.permission.REQUEST_IGNORE_BATTERY_OPTIMIZATIONS" /><uses-permission android:name="android.permission.SYSTEM_ALERT_WINDOW" /><uses-permission android:name="android.permission.VIBRATE" /><uses-permission android:name="android.permission.ACCESS_NOTIFICATION_POLICY" /><uses-permission android:name="android.permission.DISABLE_KEYGUARD" /><uses-permission android:name="android.permission.FOREGROUND_SERVICE_PHONE_CALL" /><uses-permission android:name="android.permission.READ_PHONE_STATE" /><uses-permission android:name="android.permission.CALL_PHONE" /><uses-permission android:name="android.permission.MANAGE_OWN_CALLS" /><uses-permission android:name="android.permission.BIND_TELECOM_CONNECTION_SERVICE" /><uses-feature android:name="android.hardware.camera" android:required="false" />'
        sed -i "s|<application|$PERMISSIONS<application|g" $MANIFEST
        sed -i 's|<activity.*|<activity android:name=".MainActivity" android:configChanges="orientation\|keyboardHidden\|keyboard\|screenSize\|locale\|smallestScreenSize\|screenLayout\|uiMode" android:label="@string/title_activity_main" android:launchMode="singleTask" android:showWhenLocked="true" android:turnScreenOn="true" android:excludeFromRecents="false" android:showForAllUsers="true" android:theme="@style/AppTheme.NoActionBarLaunch" android:exported="true">|' $MANIFEST
        sed -i 's|</application>|<service android:name=".CallConnectionService" android:permission="android.permission.BIND_TELECOM_CONNECTION_SERVICE" android:exported="true"><intent-filter><action android:name="android.telecom.ConnectionService" /></intent-filter></service></application>|' $MANIFEST

    - name: Create google-services.json
      run: echo '${{ secrets.GOOGLE_SERVICES_JSON }}' > android/app/google-services.json

    - name: Sync Capacitor
      run: npx cap sync
    
    - name: Grant execute permission
      run: chmod +x android/gradlew
    
    - name: Build APK
      run: |
        cd android
        ./gradlew assembleDebug --no-daemon --stacktrace
    
    - name: Upload APK
      uses: actions/upload-artifact@v4
      with:
        name: app-debug-final
        path: android/app/build/outputs/apk/debug/app-debug.apk
        retention-days: 30
