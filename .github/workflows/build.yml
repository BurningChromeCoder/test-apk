name: Build APK Completo - Fix VibraciÃ³n y Velocidad

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
    
    - name: Setup Java 21
      uses: actions/setup-java@v4
      with:
        distribution: 'temurin'
        java-version: '21'
    
    - name: Install Dependencies
      run: npm install

    - name: Build Web Assets
      run: npm run build
      
    - name: Add Android platform
      run: npx cap add android || true

    - name: Create All Native Plugins
      run: |
        mkdir -p android/app/src/main/java/com/mipuerta/app
        
        cat > android/app/src/main/java/com/mipuerta/app/WakeLockPlugin.java << 'WAKEOF'
        package com.mipuerta.app;
        import android.app.Activity;
        import android.content.Context;
        import android.os.PowerManager;
        import android.view.WindowManager;
        import com.getcapacitor.Plugin;
        import com.getcapacitor.PluginCall;
        import com.getcapacitor.PluginMethod;
        import com.getcapacitor.annotation.CapacitorPlugin;
        @CapacitorPlugin(name = "WakeLock")
        public class WakeLockPlugin extends Plugin {
            @PluginMethod
            public void acquire(PluginCall call) {
                Activity activity = getActivity();
                activity.runOnUiThread(() -> {
                    try {
                        PowerManager pm = (PowerManager) activity.getSystemService(Context.POWER_SERVICE);
                        PowerManager.WakeLock wl = pm.newWakeLock(PowerManager.FULL_WAKE_LOCK | PowerManager.ACQUIRE_CAUSES_WAKEUP, "MiPuerta:Wake");
                        wl.acquire(10000);
                        activity.getWindow().addFlags(WindowManager.LayoutParams.FLAG_SHOW_WHEN_LOCKED | WindowManager.LayoutParams.FLAG_TURN_SCREEN_ON | WindowManager.LayoutParams.FLAG_KEEP_SCREEN_ON);
                        call.resolve();
                    } catch (Exception e) { call.reject(e.getMessage()); }
                });
            }
            @PluginMethod
            public void release(PluginCall call) {
                Activity activity = getActivity();
                activity.runOnUiThread(() -> {
                    try {
                        activity.getWindow().clearFlags(WindowManager.LayoutParams.FLAG_SHOW_WHEN_LOCKED | WindowManager.LayoutParams.FLAG_TURN_SCREEN_ON | WindowManager.LayoutParams.FLAG_KEEP_SCREEN_ON);
                        call.resolve();
                    } catch (Exception e) { call.reject(e.getMessage()); }
                });
            }
        }
        WAKEOF
        
        cat > android/app/src/main/java/com/mipuerta/app/CallPlugin.java << 'CALLEOF'
        package com.mipuerta.app;
        import android.Manifest;
        import android.app.Activity;
        import android.app.NotificationChannel;
        import android.app.NotificationManager;
        import android.app.PendingIntent;
        import android.content.Context;
        import android.content.Intent;
        import android.media.AudioAttributes;
        import android.media.Ringtone;
        import android.media.RingtoneManager;
        import android.net.Uri;
        import android.os.Build;
        import android.os.PowerManager;
        import android.os.VibrationEffect;
        import android.os.Vibrator;
        import android.view.WindowManager;
        import androidx.core.app.NotificationCompat;
        import com.getcapacitor.Plugin;
        import com.getcapacitor.PluginCall;
        import com.getcapacitor.PluginMethod;
        import com.getcapacitor.annotation.CapacitorPlugin;
        import com.getcapacitor.annotation.Permission;

        @CapacitorPlugin(name = "CallPlugin", permissions = {
            @Permission(alias = "audio", strings = {Manifest.permission.RECORD_AUDIO, Manifest.permission.MODIFY_AUDIO_SETTINGS}),
            @Permission(alias = "phone", strings = {Manifest.permission.READ_PHONE_STATE, Manifest.permission.CALL_PHONE}),
            @Permission(alias = "vibrate", strings = {Manifest.permission.VIBRATE})
        })
        public class CallPlugin extends Plugin {
            private Ringtone currentRingtone;
            private Vibrator vibrator;

            @PluginMethod
            public void requestBatteryOptimization(PluginCall call) {
                Context context = getContext();
                if (Build.VERSION.SDK_INT >= Build.VERSION_CODES.M) {
                    Intent intent = new Intent();
                    String packageName = context.getPackageName();
                    PowerManager pm = (PowerManager) context.getSystemService(Context.POWER_SERVICE);
                    if (!pm.isIgnoringBatteryOptimizations(packageName)) {
                        intent.setAction(android.provider.Settings.ACTION_REQUEST_IGNORE_BATTERY_OPTIMIZATIONS);
                        intent.setData(Uri.parse("package:" + packageName));
                        intent.setFlags(Intent.FLAG_ACTIVITY_NEW_TASK);
                        context.startActivity(intent);
                        call.resolve();
                    } else {
                        call.resolve();
                    }
                } else {
                    call.resolve();
                }
            }

            @PluginMethod
            public void exitApp(PluginCall call) {
                Activity activity = getActivity();
                activity.runOnUiThread(() -> {
                    activity.moveTaskToBack(true);
                    call.resolve();
                });
            }

            @PluginMethod
            public void showIncomingCall(PluginCall call) {
                String ringtoneType = call.getString("ringtoneType", "TYPE_RINGTONE");
                Activity activity = getActivity();
                vibrator = (Vibrator) activity.getSystemService(Context.VIBRATOR_SERVICE);

                activity.runOnUiThread(() -> {
                    try {
                        // 1. ENCENDIDO INSTANTÃNEO
                        PowerManager pm = (PowerManager) activity.getSystemService(Context.POWER_SERVICE);
                        PowerManager.WakeLock wl = pm.newWakeLock(PowerManager.FULL_WAKE_LOCK | PowerManager.ACQUIRE_CAUSES_WAKEUP, "MiPuerta:FastWake");
                        wl.acquire(20000);
                        activity.getWindow().addFlags(WindowManager.LayoutParams.FLAG_SHOW_WHEN_LOCKED | WindowManager.LayoutParams.FLAG_TURN_SCREEN_ON | WindowManager.LayoutParams.FLAG_DISMISS_KEYGUARD | WindowManager.LayoutParams.FLAG_KEEP_SCREEN_ON);

                        // 2. SONIDO SIN ESPERAS
                        if (currentRingtone != null) currentRingtone.stop();
                        int type = "TYPE_ALARM".equals(ringtoneType) ? RingtoneManager.TYPE_ALARM : RingtoneManager.TYPE_RINGTONE;
                        Uri uri = RingtoneManager.getDefaultUri(type);
                        currentRingtone = RingtoneManager.getRingtone(activity, uri);
                        if (currentRingtone != null) {
                            if (Build.VERSION.SDK_INT >= Build.VERSION_CODES.LOLLIPOP) {
                                currentRingtone.setAudioAttributes(new AudioAttributes.Builder().setUsage(AudioAttributes.USAGE_ALARM).build());
                            }
                            currentRingtone.play();
                        }

                        // 3. VIBRACIÃ“N INTEGRADA (Para evitar error JS)
                        if (vibrator != null) {
                            long[] pattern = {0, 800, 200, 800, 200, 800};
                            if (Build.VERSION.SDK_INT >= Build.VERSION_CODES.O) {
                                vibrator.vibrate(VibrationEffect.createWaveform(pattern, 0));
                            } else {
                                vibrator.vibrate(pattern, 0);
                            }
                        }

                        // 4. NOTIFICACIÃ“N
                        NotificationManager nm = (NotificationManager) activity.getSystemService(Context.NOTIFICATION_SERVICE);
                        if (Build.VERSION.SDK_INT >= Build.VERSION_CODES.O) {
                            NotificationChannel channel = new NotificationChannel("urgent_calls", "Llamadas Urgentes", NotificationManager.IMPORTANCE_HIGH);
                            channel.setBypassDnd(true);
                            channel.setLockscreenVisibility(android.app.Notification.VISIBILITY_PUBLIC);
                            nm.createNotificationChannel(channel);
                        }

                        Intent intent = new Intent(activity, activity.getClass());
                        intent.addFlags(Intent.FLAG_ACTIVITY_NEW_TASK | Intent.FLAG_ACTIVITY_SINGLE_TOP);
                        PendingIntent pi = PendingIntent.getActivity(activity, 0, intent, PendingIntent.FLAG_UPDATE_CURRENT | PendingIntent.FLAG_IMMUTABLE);

                        NotificationCompat.Builder builder = new NotificationCompat.Builder(activity, "urgent_calls")
                            .setSmallIcon(android.R.drawable.ic_menu_call)
                            .setContentTitle("ðŸš¨ Â¡ALGUIEN EN LA PUERTA!")
                            .setContentText("Toca para contestar")
                            .setPriority(NotificationCompat.PRIORITY_MAX)
                            .setCategory(NotificationCompat.CATEGORY_CALL)
                            .setFullScreenIntent(pi, true)
                            .setVisibility(NotificationCompat.VISIBILITY_PUBLIC)
                            .setOngoing(true);

                        nm.notify(999, builder.build());
                        call.resolve();
                    } catch (Exception e) { call.reject(e.getMessage()); }
                });
            }

            @PluginMethod
            public void endCall(PluginCall call) {
                if (currentRingtone != null) currentRingtone.stop();
                if (vibrator != null) vibrator.cancel();
                NotificationManager nm = (NotificationManager) getContext().getSystemService(Context.NOTIFICATION_SERVICE);
                nm.cancel(999);
                call.resolve();
            }
            
            @PluginMethod
            public void vibrate(PluginCall call) {
                vibrator = (Vibrator) getContext().getSystemService(Context.VIBRATOR_SERVICE);
                if (vibrator != null) {
                    if (Build.VERSION.SDK_INT >= Build.VERSION_CODES.O) {
                        vibrator.vibrate(VibrationEffect.createOneShot(200, VibrationEffect.DEFAULT_AMPLITUDE));
                    } else {
                        vibrator.vibrate(200);
                    }
                }
                call.resolve();
            }
        }
        CALLEOF
        
        cat > android/app/src/main/java/com/mipuerta/app/MainActivity.java << 'MAINEOF'
        package com.mipuerta.app;
        import android.os.Bundle;
        import com.getcapacitor.BridgeActivity;
        public class MainActivity extends BridgeActivity {
            @Override
            public void onCreate(Bundle savedInstanceState) {
                registerPlugin(WakeLockPlugin.class);
                registerPlugin(CallPlugin.class);
                super.onCreate(savedInstanceState);
            }
        }
        MAINEOF

    - name: Configure AndroidManifest
      run: |
        MANIFEST="android/app/src/main/AndroidManifest.xml"
        PERMISSIONS='<uses-permission android:name="android.permission.INTERNET" /><uses-permission android:name="android.permission.WAKE_LOCK" /><uses-permission android:name="android.permission.VIBRATE" /><uses-permission android:name="android.permission.RECORD_AUDIO" /><uses-permission android:name="android.permission.MODIFY_AUDIO_SETTINGS" /><uses-permission android:name="android.permission.USE_FULL_SCREEN_INTENT" /><uses-permission android:name="android.permission.DISABLE_KEYGUARD" /><uses-permission android:name="android.permission.SYSTEM_ALERT_WINDOW" /><uses-permission android:name="android.permission.READ_PHONE_STATE" /><uses-permission android:name="android.permission.CALL_PHONE" /><uses-permission android:name="android.permission.REQUEST_IGNORE_BATTERY_OPTIMIZATIONS" />'
        sed -i "s|<application|$PERMISSIONS<application|g" $MANIFEST
        sed -i 's|<activity.*|<activity android:name=".MainActivity" android:configChanges="orientation\|keyboardHidden\|keyboard\|screenSize\|locale\|smallestScreenSize\|screenLayout\|uiMode" android:label="@string/title_activity_main" android:launchMode="singleInstance" android:showWhenLocked="true" android:turnScreenOn="true" android:theme="@style/AppTheme.NoActionBarLaunch" android:exported="true">|' $MANIFEST

    - name: Create google-services.json
      run: echo '${{ secrets.GOOGLE_SERVICES_JSON }}' > android/app/google-services.json

    - name: Sync Capacitor
      run: npx cap sync
    
    - name: Grant execute permission
      run: chmod +x android/gradlew
    
    - name: Build APK
      run: |
        cd android
        ./gradlew assembleDebug --no-daemon
    
    - name: Upload APK
      uses: actions/upload-artifact@v4
      with:
        name: app-debug-fast-fix
        path: android/app/build/outputs/apk/debug/app-debug.apk
