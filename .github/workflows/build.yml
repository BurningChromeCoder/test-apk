name: Build APK Completo - Full Background Fix

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
    
    - name: Setup Java 21
      uses: actions/setup-java@v4
      with:
        distribution: 'temurin'
        java-version: '21'
    
    - name: Install Dependencies
      run: npm install

    - name: Build Web Assets
      run: npm run build
      
    - name: Add Android platform
      run: npx cap add android || true

    - name: Create All Native Plugins y Messaging Service
      run: |
        mkdir -p android/app/src/main/java/com/mipuerta/app
        
        # 1. MESSAGING SERVICE (Detecta el mensaje push con la app cerrada)
        cat > android/app/src/main/java/com/mipuerta/app/MyMessagingService.java << 'MSGEF'
        package com.mipuerta.app;
        import android.util.Log;
        import com.google.firebase.messaging.FirebaseMessagingService;
        import com.google.firebase.messaging.RemoteMessage;

        public class MyMessagingService extends FirebaseMessagingService {
            @Override
            public void onMessageReceived(RemoteMessage remoteMessage) {
                super.onMessageReceived(remoteMessage);
                Log.d("MiPuerta", " Mensaje de Firebase recibido en segundo plano");
                
                // Si el mensaje trae datos de la sala, disparamos la alerta nativa
                if (remoteMessage.getData().containsKey("sala")) {
                    CallPlugin.showIncomingCallNative(getApplicationContext());
                }
            }
        }
        MSGEF

        # 2. CALL PLUGIN (Vibraci贸n, Sonido, Notificaciones y Bater铆a)
        cat > android/app/src/main/java/com/mipuerta/app/CallPlugin.java << 'CALLEOF'
        package com.mipuerta.app;
        import android.Manifest;
        import android.app.NotificationChannel;
        import android.app.NotificationManager;
        import android.app.PendingIntent;
        import android.content.Context;
        import android.content.Intent;
        import android.media.AudioAttributes;
        import android.media.Ringtone;
        import android.media.RingtoneManager;
        import android.net.Uri;
        import android.os.Build;
        import android.os.PowerManager;
        import android.os.VibrationEffect;
        import android.os.Vibrator;
        import androidx.core.app.NotificationCompat;
        import com.getcapacitor.Plugin;
        import com.getcapacitor.PluginCall;
        import com.getcapacitor.PluginMethod;
        import com.getcapacitor.annotation.CapacitorPlugin;
        import com.getcapacitor.annotation.Permission;

        @CapacitorPlugin(name = "CallPlugin", permissions = {
            @Permission(alias = "vibrate", strings = {Manifest.permission.VIBRATE})
        })
        public class CallPlugin extends Plugin {
            private static Ringtone ringtone;
            private static Vibrator vibrator;

            // MTODO ESTTICO: Puede ser llamado por el Service sin que la app est茅 abierta
            public static void showIncomingCallNative(Context context) {
                // Despertar CPU y Pantalla
                PowerManager pm = (PowerManager) context.getSystemService(Context.POWER_SERVICE);
                PowerManager.WakeLock wl = pm.newWakeLock(PowerManager.FULL_WAKE_LOCK | PowerManager.ACQUIRE_CAUSES_WAKEUP, "MiPuerta:IncomingWake");
                wl.acquire(30000);

                // Iniciar Ringtone
                if (ringtone != null) ringtone.stop();
                Uri uri = RingtoneManager.getDefaultUri(RingtoneManager.TYPE_RINGTONE);
                ringtone = RingtoneManager.getRingtone(context, uri);
                if (ringtone != null) {
                    if (Build.VERSION.SDK_INT >= Build.VERSION_CODES.LOLLIPOP) {
                        ringtone.setAudioAttributes(new AudioAttributes.Builder().setUsage(AudioAttributes.USAGE_ALARM).build());
                    }
                    ringtone.play();
                }

                // Iniciar Vibraci贸n infinita
                vibrator = (Vibrator) context.getSystemService(Context.VIBRATOR_SERVICE);
                if (vibrator != null) {
                    long[] pattern = {0, 1000, 500, 1000, 500};
                    if (Build.VERSION.SDK_INT >= Build.VERSION_CODES.O) {
                        vibrator.vibrate(VibrationEffect.createWaveform(pattern, 0));
                    } else {
                        vibrator.vibrate(pattern, 0);
                    }
                }

                // Crear Canal de Notificaci贸n de alta prioridad
                NotificationManager nm = (NotificationManager) context.getSystemService(Context.NOTIFICATION_SERVICE);
                String cid = "urgent_calls";
                if (Build.VERSION.SDK_INT >= Build.VERSION_CODES.O) {
                    NotificationChannel channel = new NotificationChannel(cid, "Llamadas Urgentes", NotificationManager.IMPORTANCE_HIGH);
                    channel.setBypassDnd(true);
                    channel.setLockscreenVisibility(android.app.Notification.VISIBILITY_PUBLIC);
                    nm.createNotificationChannel(channel);
                }

                // Intent para abrir la app al tocar la notificaci贸n
                Intent intent = new Intent(context, MainActivity.class);
                intent.addFlags(Intent.FLAG_ACTIVITY_NEW_TASK | Intent.FLAG_ACTIVITY_SINGLE_TOP);
                PendingIntent pi = PendingIntent.getActivity(context, 0, intent, PendingIntent.FLAG_UPDATE_CURRENT | PendingIntent.FLAG_IMMUTABLE);

                NotificationCompat.Builder builder = new NotificationCompat.Builder(context, cid)
                    .setSmallIcon(android.R.drawable.ic_menu_call)
                    .setContentTitle(" 隆ALGUIEN EN LA PUERTA!")
                    .setContentText("Toca para contestar")
                    .setPriority(NotificationCompat.PRIORITY_MAX)
                    .setCategory(NotificationCompat.CATEGORY_CALL)
                    .setFullScreenIntent(pi, true) // Esto abre la app sobre el bloqueo
                    .setVisibility(NotificationCompat.VISIBILITY_PUBLIC)
                    .setOngoing(true);

                nm.notify(999, builder.build());
            }

            @PluginMethod
            public void showIncomingCall(PluginCall call) {
                showIncomingCallNative(getContext());
                call.resolve();
            }

            @PluginMethod
            public void endCall(PluginCall call) {
                if (ringtone != null) ringtone.stop();
                if (vibrator != null) vibrator.cancel();
                NotificationManager nm = (NotificationManager) getContext().getSystemService(Context.NOTIFICATION_SERVICE);
                nm.cancel(999);
                call.resolve();
            }

            @PluginMethod
            public void vibrate(PluginCall call) {
                Vibrator v = (Vibrator) getContext().getSystemService(Context.VIBRATOR_SERVICE);
                if (v != null) {
                    if (Build.VERSION.SDK_INT >= Build.VERSION_CODES.O) {
                        v.vibrate(VibrationEffect.createOneShot(200, VibrationEffect.DEFAULT_AMPLITUDE));
                    } else {
                        v.vibrate(200);
                    }
                }
                call.resolve();
            }

            @PluginMethod
            public void requestBatteryOptimization(PluginCall call) {
                Context context = getContext();
                if (Build.VERSION.SDK_INT >= Build.VERSION_CODES.M) {
                    PowerManager pm = (PowerManager) context.getSystemService(Context.POWER_SERVICE);
                    if (!pm.isIgnoringBatteryOptimizations(context.getPackageName())) {
                        Intent intent = new Intent(android.provider.Settings.ACTION_REQUEST_IGNORE_BATTERY_OPTIMIZATIONS);
                        intent.setData(Uri.parse("package:" + context.getPackageName()));
                        intent.setFlags(Intent.FLAG_ACTIVITY_NEW_TASK);
                        context.startActivity(intent);
                    }
                }
                call.resolve();
            }

            @PluginMethod
            public void exitApp(PluginCall call) {
                getActivity().moveTaskToBack(true);
                call.resolve();
            }
        }
        CALLEOF

        cat > android/app/src/main/java/com/mipuerta/app/WakeLockPlugin.java << 'WAKEOF'
        package com.mipuerta.app;
        import android.view.WindowManager;
        import com.getcapacitor.Plugin;
        import com.getcapacitor.PluginCall;
        import com.getcapacitor.PluginMethod;
        import com.getcapacitor.annotation.CapacitorPlugin;
        @CapacitorPlugin(name = "WakeLock")
        public class WakeLockPlugin extends Plugin {
            @PluginMethod
            public void acquire(PluginCall call) {
                getActivity().runOnUiThread(() -> {
                    getActivity().getWindow().addFlags(WindowManager.LayoutParams.FLAG_SHOW_WHEN_LOCKED | WindowManager.LayoutParams.FLAG_TURN_SCREEN_ON | WindowManager.LayoutParams.FLAG_KEEP_SCREEN_ON | WindowManager.LayoutParams.FLAG_DISMISS_KEYGUARD);
                    call.resolve();
                });
            }
            @PluginMethod
            public void release(PluginCall call) {
                getActivity().runOnUiThread(() -> {
                    getActivity().getWindow().clearFlags(WindowManager.LayoutParams.FLAG_SHOW_WHEN_LOCKED | WindowManager.LayoutParams.FLAG_TURN_SCREEN_ON | WindowManager.LayoutParams.FLAG_KEEP_SCREEN_ON | WindowManager.LayoutParams.FLAG_DISMISS_KEYGUARD);
                    call.resolve();
                });
            }
        }
        WAKEOF

        cat > android/app/src/main/java/com/mipuerta/app/MainActivity.java << 'MAINEOF'
        package com.mipuerta.app;
        import android.os.Bundle;
        import com.getcapacitor.BridgeActivity;
        public class MainActivity extends BridgeActivity {
            @Override
            public void onCreate(Bundle savedInstanceState) {
                registerPlugin(WakeLockPlugin.class);
                registerPlugin(CallPlugin.class);
                super.onCreate(savedInstanceState);
            }
        }
        MAINEOF

    - name: Configure AndroidManifest
      run: |
        MANIFEST="android/app/src/main/AndroidManifest.xml"
        
        # Registrar el Service para que Android sepa que existe
        SERVICE_TAG='<service android:name=".MyMessagingService" android:exported="false"><intent-filter><action android:name="com.google.firebase.MESSAGING_EVENT" /></intent-filter></service>'
        sed -i "s|</activity>|</activity>$SERVICE_TAG|g" $MANIFEST
        
        # Inyectar todos los permisos necesarios
        PERMISSIONS='<uses-permission android:name="android.permission.WAKE_LOCK" /><uses-permission android:name="android.permission.VIBRATE" /><uses-permission android:name="android.permission.USE_FULL_SCREEN_INTENT" /><uses-permission android:name="android.permission.DISABLE_KEYGUARD" /><uses-permission android:name="android.permission.REQUEST_IGNORE_BATTERY_OPTIMIZATIONS" /><uses-permission android:name="android.permission.SYSTEM_ALERT_WINDOW" />'
        sed -i "s|<application|$PERMISSIONS<application|g" $MANIFEST
        
        # Configurar la actividad principal para que sea visible en el lockscreen
        sed -i 's|<activity.*|<activity android:name=".MainActivity" android:configChanges="orientation\|keyboardHidden\|keyboard\|screenSize\|locale\|smallestScreenSize\|screenLayout\|uiMode" android:label="@string/title_activity_main" android:launchMode="singleInstance" android:showWhenLocked="true" android:turnScreenOn="true" android:theme="@style/AppTheme.NoActionBarLaunch" android:exported="true">|' $MANIFEST

    - name: Create google-services.json
      run: echo '${{ secrets.GOOGLE_SERVICES_JSON }}' > android/app/google-services.json

    - name: Sync Capacitor
      run: npx cap sync
    
    - name: Grant execute permission
      run: chmod +x android/gradlew
    
    - name: Build APK
      run: |
        cd android
        ./gradlew assembleDebug --no-daemon
    
    - name: Upload APK
      uses: actions/upload-artifact@v4
      with:
        name: app-debug-full-fix
        path: android/app/build/outputs/apk/debug/app-debug.apk
