name: Build APK Completo - Fix Despertador Nativo

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
    
    - name: Setup Java 21
      uses: actions/setup-java@v4
      with:
        distribution: 'temurin'
        java-version: '21'
    
    - name: Install Dependencies
      run: npm install

    - name: Build Web Assets
      run: npm run build
      
    - name: Add Android platform
      run: npx cap add android || true

    - name: Create Native Plugins and Background Service
      run: |
        mkdir -p android/app/src/main/java/com/mipuerta/app
        
        # 1. MESSAGING SERVICE: El encargado de escuchar a Firebase con la app cerrada
        cat > android/app/src/main/java/com/mipuerta/app/MyMessagingService.java << 'MSGEF'
        package com.mipuerta.app;
        import android.util.Log;
        import com.google.firebase.messaging.FirebaseMessagingService;
        import com.google.firebase.messaging.RemoteMessage;

        public class MyMessagingService extends FirebaseMessagingService {
            @Override
            public void onMessageReceived(RemoteMessage remoteMessage) {
                super.onMessageReceived(remoteMessage);
                Log.d("MiPuerta", " Se帽al recibida de Firebase");
                
                // Si el mensaje es de una llamada entrante, disparamos el aviso nativo
                if (remoteMessage.getData().containsKey("sala")) {
                    CallPlugin.showIncomingCallNative(getApplicationContext());
                }
            }
        }
        MSGEF

        # 2. CALL PLUGIN: Centraliza la l贸gica de sonido, vibraci贸n y avisos
        cat > android/app/src/main/java/com/mipuerta/app/CallPlugin.java << 'CALLEOF'
        package com.mipuerta.app;
        import android.Manifest;
        import android.app.NotificationChannel;
        import android.app.NotificationManager;
        import android.app.PendingIntent;
        import android.content.Context;
        import android.content.Intent;
        import android.media.AudioAttributes;
        import android.media.Ringtone;
        import android.media.RingtoneManager;
        import android.net.Uri;
        import android.os.Build;
        import android.os.PowerManager;
        import android.os.VibrationEffect;
        import android.os.Vibrator;
        import androidx.core.app.NotificationCompat;
        import com.getcapacitor.Plugin;
        import com.getcapacitor.PluginCall;
        import com.getcapacitor.PluginMethod;
        import com.getcapacitor.annotation.CapacitorPlugin;
        import com.getcapacitor.annotation.Permission;

        @CapacitorPlugin(name = "CallPlugin", permissions = {
            @Permission(alias = "vibrate", strings = {Manifest.permission.VIBRATE})
        })
        public class CallPlugin extends Plugin {
            private static Ringtone ringtone;
            private static Vibrator vibrator;

            // MTODO MAESTRO: Se llama desde el Service o desde JS
            public static void showIncomingCallNative(Context context) {
                // Forzar encendido de pantalla
                PowerManager pm = (PowerManager) context.getSystemService(Context.POWER_SERVICE);
                PowerManager.WakeLock wl = pm.newWakeLock(PowerManager.FULL_WAKE_LOCK | PowerManager.ACQUIRE_CAUSES_WAKEUP, "MiPuerta:Wake");
                if (!wl.isHeld()) wl.acquire(30000);

                // Sonido del sistema
                if (ringtone != null) ringtone.stop();
                Uri uri = RingtoneManager.getDefaultUri(RingtoneManager.TYPE_RINGTONE);
                ringtone = RingtoneManager.getRingtone(context, uri);
                if (ringtone != null) {
                    if (Build.VERSION.SDK_INT >= Build.VERSION_CODES.LOLLIPOP) {
                        ringtone.setAudioAttributes(new AudioAttributes.Builder().setUsage(AudioAttributes.USAGE_ALARM).build());
                    }
                    ringtone.play();
                }

                // Vibraci贸n r铆tmica
                vibrator = (Vibrator) context.getSystemService(Context.VIBRATOR_SERVICE);
                if (vibrator != null) {
                    long[] pattern = {0, 1000, 500, 1000, 500};
                    if (Build.VERSION.SDK_INT >= Build.VERSION_CODES.O) {
                        vibrator.vibrate(VibrationEffect.createWaveform(pattern, 0));
                    } else {
                        vibrator.vibrate(pattern, 0);
                    }
                }

                // Notificaci贸n de pantalla completa (Interrumpe cualquier estado)
                NotificationManager nm = (NotificationManager) context.getSystemService(Context.NOTIFICATION_SERVICE);
                String channelId = "urgent_calls";
                if (Build.VERSION.SDK_INT >= Build.VERSION_CODES.O) {
                    NotificationChannel channel = new NotificationChannel(channelId, "Llamadas Urgentes", NotificationManager.IMPORTANCE_HIGH);
                    channel.setBypassDnd(true);
                    nm.createNotificationChannel(channel);
                }

                Intent intent = new Intent(context, MainActivity.class);
                intent.addFlags(Intent.FLAG_ACTIVITY_NEW_TASK | Intent.FLAG_ACTIVITY_SINGLE_TOP);
                PendingIntent pi = PendingIntent.getActivity(context, 0, intent, PendingIntent.FLAG_UPDATE_CURRENT | PendingIntent.FLAG_IMMUTABLE);

                NotificationCompat.Builder builder = new NotificationCompat.Builder(context, channelId)
                    .setSmallIcon(android.R.drawable.ic_menu_call)
                    .setContentTitle(" 隆ALGUIEN EN LA PUERTA!")
                    .setContentText("Toca para contestar")
                    .setPriority(NotificationCompat.PRIORITY_MAX)
                    .setCategory(NotificationCompat.CATEGORY_CALL)
                    .setFullScreenIntent(pi, true)
                    .setOngoing(true);

                nm.notify(999, builder.build());
            }

            @PluginMethod
            public void showIncomingCall(PluginCall call) {
                showIncomingCallNative(getContext());
                call.resolve();
            }

            @PluginMethod
            public void endCall(PluginCall call) {
                if (ringtone != null) ringtone.stop();
                if (vibrator != null) vibrator.cancel();
                NotificationManager nm = (NotificationManager) getContext().getSystemService(Context.NOTIFICATION_SERVICE);
                nm.cancel(999);
                call.resolve();
            }

            @PluginMethod
            public void requestBatteryOptimization(PluginCall call) {
                if (Build.VERSION.SDK_INT >= Build.VERSION_CODES.M) {
                    Intent intent = new Intent(android.provider.Settings.ACTION_REQUEST_IGNORE_BATTERY_OPTIMIZATIONS);
                    intent.setData(Uri.parse("package:" + getContext().getPackageName()));
                    intent.setFlags(Intent.FLAG_ACTIVITY_NEW_TASK);
                    getContext().startActivity(intent);
                }
                call.resolve();
            }

            @PluginMethod
            public void exitApp(PluginCall call) {
                getActivity().moveTaskToBack(true);
                call.resolve();
            }
        }
        CALLEOF

        # 3. WAKE LOCK: Mantiene la pantalla activa durante la llamada
        cat > android/app/src/main/java/com/mipuerta/app/WakeLockPlugin.java << 'WAKEOF'
        package com.mipuerta.app;
        import android.view.WindowManager;
        import com.getcapacitor.Plugin;
        import com.getcapacitor.PluginCall;
        import com.getcapacitor.PluginMethod;
        import com.getcapacitor.annotation.CapacitorPlugin;
        @CapacitorPlugin(name = "WakeLock")
        public class WakeLockPlugin extends Plugin {
            @PluginMethod
            public void acquire(PluginCall call) {
                getActivity().runOnUiThread(() -> {
                    getActivity().getWindow().addFlags(WindowManager.LayoutParams.FLAG_SHOW_WHEN_LOCKED | WindowManager.LayoutParams.FLAG_TURN_SCREEN_ON | WindowManager.LayoutParams.FLAG_KEEP_SCREEN_ON | WindowManager.LayoutParams.FLAG_DISMISS_KEYGUARD);
                    call.resolve();
                });
            }
            @PluginMethod
            public void release(PluginCall call) {
                getActivity().runOnUiThread(() -> {
                    getActivity().getWindow().clearFlags(WindowManager.LayoutParams.FLAG_SHOW_WHEN_LOCKED | WindowManager.LayoutParams.FLAG_TURN_SCREEN_ON | WindowManager.LayoutParams.FLAG_KEEP_SCREEN_ON | WindowManager.LayoutParams.FLAG_DISMISS_KEYGUARD);
                    call.resolve();
                });
            }
        }
        WAKEOF

        # 4. MAIN ACTIVITY: Registro de plugins
        cat > android/app/src/main/java/com/mipuerta/app/MainActivity.java << 'MAINEOF'
        package com.mipuerta.app;
        import android.os.Bundle;
        import com.getcapacitor.BridgeActivity;
        public class MainActivity extends BridgeActivity {
            @Override
            public void onCreate(Bundle savedInstanceState) {
                registerPlugin(WakeLockPlugin.class);
                registerPlugin(CallPlugin.class);
                super.onCreate(savedInstanceState);
            }
        }
        MAINEOF

    - name: Inject Dependencies and Configure Manifest
      run: |
        MANIFEST="android/app/src/main/AndroidManifest.xml"
        GRADLE_APP="android/app/build.gradle"
        
        # Inyectar dependencia necesaria para Firebase Messaging
        sed -i "/dependencies {/a \    implementation 'com.google.firebase:firebase-messaging:23.4.1'" $GRADLE_APP
        
        # Registrar el Service en el Manifest
        SERVICE_TAG='<service android:name=".MyMessagingService" android:exported="false"><intent-filter><action android:name="com.google.firebase.MESSAGING_EVENT" /></intent-filter></service>'
        sed -i "s|</activity>|</activity>$SERVICE_TAG|g" $MANIFEST
        
        # Inyectar Permisos y configuraciones de pantalla
        PERMISSIONS='<uses-permission android:name="android.permission.WAKE_LOCK" /><uses-permission android:name="android.permission.VIBRATE" /><uses-permission android:name="android.permission.USE_FULL_SCREEN_INTENT" /><uses-permission android:name="android.permission.DISABLE_KEYGUARD" /><uses-permission android:name="android.permission.REQUEST_IGNORE_BATTERY_OPTIMIZATIONS" />'
        sed -i "s|<application|$PERMISSIONS<application|g" $MANIFEST
        
        # Asegurar que la actividad principal pueda "traspasar" el bloqueo de pantalla
        sed -i 's|<activity.*|<activity android:name=".MainActivity" android:configChanges="orientation\|keyboardHidden\|keyboard\|screenSize\|locale\|smallestScreenSize\|screenLayout\|uiMode" android:label="@string/title_activity_main" android:launchMode="singleInstance" android:showWhenLocked="true" android:turnScreenOn="true" android:theme="@style/AppTheme.NoActionBarLaunch" android:exported="true">|' $MANIFEST

    - name: Create google-services.json
      run: echo '${{ secrets.GOOGLE_SERVICES_JSON }}' > android/app/google-services.json

    - name: Sync Capacitor
      run: npx cap sync
    
    - name: Grant execute permission
      run: chmod +x android/gradlew
    
    - name: Build APK
      run: |
        cd android
        ./gradlew assembleDebug --no-daemon
    
    - name: Upload APK
      uses: actions/upload-artifact@v4
      with:
        name: app-debug-final-optimized
        path: android/app/build/outputs/apk/debug/app-debug.apk
