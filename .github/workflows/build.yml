name: Build APK Completo - Fix Notificaciones

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
    
    - name: Setup Java 21
      uses: actions/setup-java@v4
      with:
        distribution: 'temurin'
        java-version: '21'
    
    - name: Install Dependencies
      run: npm install

    - name: Build Web Assets
      run: npm run build
      
    - name: Add Android platform
      run: npx cap add android || true

    - name: Create All Native Plugins
      run: |
        mkdir -p android/app/src/main/java/com/mipuerta/app
        
        cat > android/app/src/main/java/com/mipuerta/app/WakeLockPlugin.java << 'WAKEOF'
        package com.mipuerta.app;
        import android.app.Activity;
        import android.content.Context;
        import android.os.Build;
        import android.os.PowerManager;
        import android.view.WindowManager;
        import com.getcapacitor.JSObject;
        import com.getcapacitor.Plugin;
        import com.getcapacitor.PluginCall;
        import com.getcapacitor.PluginMethod;
        import com.getcapacitor.annotation.CapacitorPlugin;
        @CapacitorPlugin(name = "WakeLock")
        public class WakeLockPlugin extends Plugin {
            private PowerManager.WakeLock wakeLock;
            @PluginMethod
            public void acquire(PluginCall call) {
                Activity activity = getActivity();
                if (activity == null) {
                    call.reject("Activity not available");
                    return;
                }
                activity.runOnUiThread(() -> {
                    try {
                        PowerManager powerManager = (PowerManager) activity.getSystemService(Context.POWER_SERVICE);
                        if (wakeLock == null) {
                            wakeLock = powerManager.newWakeLock(
                                PowerManager.SCREEN_BRIGHT_WAKE_LOCK | 
                                PowerManager.ACQUIRE_CAUSES_WAKEUP |
                                PowerManager.ON_AFTER_RELEASE,
                                "MiPuerta::WakeLock"
                            );
                            wakeLock.setReferenceCounted(false);
                        }
                        if (!wakeLock.isHeld()) {
                            wakeLock.acquire(10 * 60 * 1000L);
                        }
                        if (Build.VERSION.SDK_INT >= Build.VERSION_CODES.O_MR1) {
                            activity.setShowWhenLocked(true);
                            activity.setTurnScreenOn(true);
                        } else {
                            activity.getWindow().addFlags(
                                WindowManager.LayoutParams.FLAG_SHOW_WHEN_LOCKED |
                                WindowManager.LayoutParams.FLAG_TURN_SCREEN_ON |
                                WindowManager.LayoutParams.FLAG_KEEP_SCREEN_ON
                            );
                        }
                        call.resolve();
                    } catch (Exception e) {
                        call.reject(e.getMessage());
                    }
                });
            }
            @PluginMethod
            public void release(PluginCall call) {
                if (wakeLock != null && wakeLock.isHeld()) {
                    wakeLock.release();
                }
                call.resolve();
            }
        }
        WAKEOF
        
        cat > android/app/src/main/java/com/mipuerta/app/CallConnectionService.java << 'CONNEOF'
        package com.mipuerta.app;
        import android.telecom.Connection;
        import android.telecom.ConnectionRequest;
        import android.telecom.ConnectionService;
        import android.telecom.PhoneAccountHandle;
        import android.telecom.DisconnectCause;
        import android.util.Log;
        public class CallConnectionService extends ConnectionService {
            private static CallConnection activeConnection;
            @Override
            public Connection onCreateIncomingConnection(PhoneAccountHandle connectionManagerPhoneAccount, ConnectionRequest request) {
                activeConnection = new CallConnection();
                activeConnection.setAudioModeIsVoip(true);
                activeConnection.setRinging();
                return activeConnection;
            }
            public static void endCall() {
                if (activeConnection != null) {
                    activeConnection.setDisconnected(new DisconnectCause(DisconnectCause.LOCAL));
                    activeConnection.destroy();
                    activeConnection = null;
                }
            }
            private static class CallConnection extends Connection {
                @Override
                public void onAnswer() {
                    setActive();
                    CallPlugin.notifyCallAnswered();
                }
                @Override
                public void onReject() {
                    setDisconnected(new DisconnectCause(DisconnectCause.REJECTED));
                    destroy();
                    CallPlugin.notifyCallRejected();
                }
            }
        }
        CONNEOF
        
        cat > android/app/src/main/java/com/mipuerta/app/CallPlugin.java << 'CALLEOF'
        package com.mipuerta.app;
        import android.Manifest;
        import android.app.Activity;
        import android.app.NotificationChannel;
        import android.app.NotificationManager;
        import android.app.PendingIntent;
        import android.content.ComponentName;
        import android.content.Context;
        import android.content.Intent;
        import android.media.AudioAttributes;
        import android.media.Ringtone;
        import android.media.RingtoneManager;
        import android.net.Uri;
        import android.os.Build;
        import android.os.Bundle;
        import android.os.PowerManager;
        import android.os.VibrationEffect;
        import android.os.Vibrator;
        import android.telecom.PhoneAccount;
        import android.telecom.PhoneAccountHandle;
        import android.telecom.TelecomManager;
        import android.view.WindowManager;
        import androidx.core.app.NotificationCompat;
        import com.getcapacitor.JSObject;
        import com.getcapacitor.Plugin;
        import com.getcapacitor.PluginCall;
        import com.getcapacitor.PluginMethod;
        import com.getcapacitor.annotation.CapacitorPlugin;
        import com.getcapacitor.annotation.Permission;
        import com.getcapacitor.annotation.PermissionCallback;

        @CapacitorPlugin(name = "CallPlugin", permissions = {
            @Permission(alias = "phone", strings = {Manifest.permission.READ_PHONE_STATE, Manifest.permission.CALL_PHONE}),
            @Permission(alias = "vibrate", strings = {Manifest.permission.VIBRATE})
        })
        public class CallPlugin extends Plugin {
            private static CallPlugin instance;
            private TelecomManager telecomManager;
            private PhoneAccountHandle phoneAccountHandle;
            private Ringtone currentRingtone;
            private Vibrator vibrator;

            @Override
            public void load() {
                instance = this;
                telecomManager = (TelecomManager) getContext().getSystemService(Context.TELECOM_SERVICE);
                vibrator = (Vibrator) getContext().getSystemService(Context.VIBRATOR_SERVICE);
                registerPhoneAccount();
                createNotificationChannel();
            }

            private void registerPhoneAccount() {
                ComponentName componentName = new ComponentName(getContext(), CallConnectionService.class);
                phoneAccountHandle = new PhoneAccountHandle(componentName, "MiPuertaAccount");
                PhoneAccount phoneAccount = PhoneAccount.builder(phoneAccountHandle, "MiPuerta")
                    .setCapabilities(PhoneAccount.CAPABILITY_SELF_MANAGED)
                    .build();
                telecomManager.registerPhoneAccount(phoneAccount);
            }

            private void createNotificationChannel() {
                if (Build.VERSION.SDK_INT >= Build.VERSION_CODES.O) {
                    NotificationChannel channel = new NotificationChannel("calls", "Llamadas", NotificationManager.IMPORTANCE_HIGH);
                    channel.setLockscreenVisibility(android.app.Notification.VISIBILITY_PUBLIC);
                    NotificationManager nm = (NotificationManager) getContext().getSystemService(Context.NOTIFICATION_SERVICE);
                    nm.createNotificationChannel(channel);
                }
            }

            @PluginMethod
            public void showIncomingCall(PluginCall call) {
                String ringtoneType = call.getString("ringtoneType", "TYPE_RINGTONE");
                Activity activity = getActivity();
                
                activity.runOnUiThread(() -> {
                    try {
                        // 1. WAKE UP
                        PowerManager pm = (PowerManager) activity.getSystemService(Context.POWER_SERVICE);
                        PowerManager.WakeLock wl = pm.newWakeLock(PowerManager.FULL_WAKE_LOCK | PowerManager.ACQUIRE_CAUSES_WAKEUP, "MiPuerta:Wake");
                        wl.acquire(10000);

                        // 2. FLAGS
                        if (Build.VERSION.SDK_INT >= Build.VERSION_CODES.O_MR1) {
                            activity.setShowWhenLocked(true);
                            activity.setTurnScreenOn(true);
                        } else {
                            activity.getWindow().addFlags(WindowManager.LayoutParams.FLAG_SHOW_WHEN_LOCKED | WindowManager.LayoutParams.FLAG_TURN_SCREEN_ON);
                        }

                        // 3. SOUND
                        stopCurrentRingtone();
                        int type = RingtoneManager.TYPE_RINGTONE;
                        if ("TYPE_ALARM".equals(ringtoneType)) type = RingtoneManager.TYPE_ALARM;
                        Uri uri = RingtoneManager.getDefaultUri(type);
                        currentRingtone = RingtoneManager.getRingtone(activity, uri);
                        if (currentRingtone != null) {
                            if (Build.VERSION.SDK_INT >= Build.VERSION_CODES.LOLLIPOP) {
                                currentRingtone.setAudioAttributes(new AudioAttributes.Builder().setUsage(AudioAttributes.USAGE_NOTIFICATION_RINGTONE).build());
                            }
                            currentRingtone.play();
                        }

                        // 4. VIBRATE
                        if (vibrator != null) {
                            long[] pattern = {0, 1000, 500, 1000};
                            if (Build.VERSION.SDK_INT >= Build.VERSION_CODES.O) {
                                vibrator.vibrate(VibrationEffect.createWaveform(pattern, 0));
                            } else {
                                vibrator.vibrate(pattern, 0);
                            }
                        }

                        // 5. TELECOM
                        Bundle extras = new Bundle();
                        extras.putString("caller", "Visitante");
                        telecomManager.addNewIncomingCall(phoneAccountHandle, extras);

                        // 6. NOTIFICATION
                        Intent intent = new Intent(activity, activity.getClass());
                        PendingIntent pi = PendingIntent.getActivity(activity, 0, intent, PendingIntent.FLAG_UPDATE_CURRENT | PendingIntent.FLAG_IMMUTABLE);
                        NotificationCompat.Builder builder = new NotificationCompat.Builder(activity, "calls")
                            .setSmallIcon(android.R.drawable.sym_action_call)
                            .setContentTitle("ðŸ”” Timbre")
                            .setPriority(NotificationCompat.PRIORITY_MAX)
                            .setCategory(NotificationCompat.CATEGORY_CALL)
                            .setFullScreenIntent(pi, true);
                        
                        NotificationManager nm = (NotificationManager) activity.getSystemService(Context.NOTIFICATION_SERVICE);
                        nm.notify(1, builder.build());

                        call.resolve();
                    } catch (Exception e) {
                        call.reject(e.getMessage());
                    }
                });
            }

            @PluginMethod
            public void endCall(PluginCall call) {
                stopCurrentRingtone();
                if (vibrator != null) vibrator.cancel();
                CallConnectionService.endCall();
                NotificationManager nm = (NotificationManager) getContext().getSystemService(Context.NOTIFICATION_SERVICE);
                nm.cancel(1);
                call.resolve();
            }

            private void stopCurrentRingtone() {
                if (currentRingtone != null && currentRingtone.isPlaying()) currentRingtone.stop();
            }

            public static void notifyCallAnswered() {
                if (instance != null) {
                    instance.stopCurrentRingtone();
                    if (instance.vibrator != null) instance.vibrator.cancel();
                    JSObject data = new JSObject();
                    data.put("action", "answered");
                    instance.notifyListeners("callStateChanged", data);
                }
            }

            public static void notifyCallRejected() {
                if (instance != null) {
                    instance.stopCurrentRingtone();
                    if (instance.vibrator != null) instance.vibrator.cancel();
                    JSObject data = new JSObject();
                    data.put("action", "rejected");
                    instance.notifyListeners("callStateChanged", data);
                }
            }
        }
        CALLEOF
        
        cat > android/app/src/main/java/com/mipuerta/app/MainActivity.java << 'MAINEOF'
        package com.mipuerta.app;
        import android.os.Bundle;
        import com.getcapacitor.BridgeActivity;
        public class MainActivity extends BridgeActivity {
            @Override
            public void onCreate(Bundle savedInstanceState) {
                registerPlugin(WakeLockPlugin.class);
                registerPlugin(CallPlugin.class);
                super.onCreate(savedInstanceState);
            }
        }
        MAINEOF

    - name: Configure AndroidManifest
      run: |
        MANIFEST="android/app/src/main/AndroidManifest.xml"
        PERMISSIONS='<uses-permission android:name="android.permission.INTERNET" /><uses-permission android:name="android.permission.USE_FULL_SCREEN_INTENT" /><uses-permission android:name="android.permission.WAKE_LOCK" /><uses-permission android:name="android.permission.VIBRATE" /><uses-permission android:name="android.permission.READ_PHONE_STATE" /><uses-permission android:name="android.permission.CALL_PHONE" /><uses-permission android:name="android.permission.MANAGE_OWN_CALLS" /><uses-permission android:name="android.permission.BIND_TELECOM_CONNECTION_SERVICE" />'
        sed -i "s|<application|$PERMISSIONS<application|g" $MANIFEST
        sed -i 's|<activity.*|<activity android:name=".MainActivity" android:configChanges="orientation\|keyboardHidden\|keyboard\|screenSize\|locale\|smallestScreenSize\|screenLayout\|uiMode" android:label="@string/title_activity_main" android:launchMode="singleInstance" android:showWhenLocked="true" android:turnScreenOn="true" android:theme="@style/AppTheme.NoActionBarLaunch" android:exported="true">|' $MANIFEST
        sed -i 's|</application>|<service android:name=".CallConnectionService" android:permission="android.permission.BIND_TELECOM_CONNECTION_SERVICE" android:exported="true"><intent-filter><action android:name="android.telecom.ConnectionService" /></intent-filter></service></application>|' $MANIFEST

    - name: Create google-services.json
      run: echo '${{ secrets.GOOGLE_SERVICES_JSON }}' > android/app/google-services.json

    - name: Sync Capacitor
      run: npx cap sync
    
    - name: Grant execute permission
      run: chmod +x android/gradlew
    
    - name: Build APK
      run: |
        cd android
        ./gradlew assembleDebug --no-daemon
    
    - name: Upload APK
      uses: actions/upload-artifact@v4
      with:
        name: app-debug-fix
        path: android/app/build/outputs/apk/debug/app-debug.apk
