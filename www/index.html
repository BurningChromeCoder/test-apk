<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Monitor Puerta V3</title>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    
    <style>
        /* RESET & BASE */
        body { 
            background: #000; 
            color: #fff; 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; 
            margin: 0; 
            display: flex; 
            flex-direction: column; 
            height: 100vh; 
            overflow: hidden;
        }
        
        /* CONSOLA DE LOGS (Estilo Matrix/Hacker, m√°s peque√±a y discreta) */
        #console-log {
            position: absolute;
            top: 0; left: 0; right: 0;
            background: rgba(0,0,0,0.7); 
            color: #0f0; 
            padding: 10px; 
            height: 80px;
            overflow-y: scroll; 
            font-family: 'Courier New', monospace;
            font-size: 10px; 
            z-index: 5;
            pointer-events: none; /* Permite tocar el video debajo */
            border-bottom: 1px solid #333;
        }

        /* CONTENEDOR DE VIDEO */
        #video-wrapper { 
            width: 100%; 
            height: 100%; 
            position: relative; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            background: #121212; 
        }

        /* FIX CR√çTICO PARA EL ICONO DE PLAY EN ANDROID */
        video { 
            width: 100%; 
            height: 100%; 
            object-fit: cover; 
            display: none; /* Se muestra v√≠a JS */
        }
        
        /* Esto oculta el bot√≥n nativo de Play gigante en WebView */
        video::-webkit-media-controls { display:none !important; }
        video::-webkit-media-controls-start-playback-button { display: none !important; -webkit-appearance: none; }

        video.active { display: block; }

        /* ESTADO GRANDE (Cuando no hay video) */
        .status-big { 
            font-size: 18px; 
            color: #aaa; 
            text-align: center; 
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 15px;
        }
        .loading-spinner {
            width: 40px; height: 40px;
            border: 4px solid rgba(255,255,255,0.1);
            border-left-color: #3498db;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 100% { transform: rotate(360deg); } }
        
        /* BARRA DE CONTROLES MODERNA (Glassmorphism) */
        .controls-layer {
            position: absolute; 
            bottom: 40px; 
            left: 50%;
            transform: translateX(-50%);
            display: flex; 
            gap: 20px; 
            z-index: 20;
            background: rgba(25, 25, 25, 0.85);
            backdrop-filter: blur(10px);
            padding: 15px 25px;
            border-radius: 40px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.5);
            border: 1px solid rgba(255,255,255,0.1);
        }

        .btn { 
            width: 60px; 
            height: 60px; 
            border-radius: 50%; 
            border: none; 
            font-size: 24px; 
            cursor: pointer; 
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            color: white;
        }

        .btn:active { transform: scale(0.9); }

        /* Colores de botones */
        .btn-reload { background: #34495e; }
        .btn-mute { background: #f1c40f; color: #222; }
        .btn-mute.muted { background: #e74c3c; color: white; position: relative;}
        /* Tachado para el mute */
        .btn-mute.muted::after {
            content: ''; position: absolute; width: 60%; height: 2px; 
            background: white; transform: rotate(45deg);
        }

        .btn-hangup { background: #e74c3c; display: none; } /* Oculto por defecto */

    </style>
</head>
<body>

    <div id="console-log">
        > Iniciando Sistema V3 (con STUN)...<br>
    </div>

    <div id="video-wrapper">
        <div id="status-container" class="status-big">
            <div class="loading-spinner"></div>
            <div id="status-text">Iniciando servicios...</div>
        </div>
        
        <video id="remoteVideo" autoplay playsinline webkit-playsinline></video>
        
        <div class="controls-layer">
            <button id="btn-mute" class="btn btn-mute" onclick="toggleMute()">üé§</button>
            
            <button id="btn-hangup" class="btn btn-hangup" onclick="colgarLlamada()">üìû</button>
            
            <button class="btn btn-reload" onclick="window.location.reload()">üîÑ</button>
        </div>
    </div>

    <script type="module">
        import { PushNotifications } from '@capacitor/push-notifications';
        
        // --- CONFIGURACI√ìN ---
        const MY_ID = "puerta-admin-v2"; 
        const API_URL = 'https://registrarreceptor-6rmawrifca-uc.a.run.app';
        
        // Variables Globales
        let currentCall = null;
        let localStream = null; // Guardamos el stream para poder mutearlo
        let isMuted = false;

        function log(msg) {
            console.log(msg);
            const el = document.getElementById('console-log');
            el.innerHTML += `> ${msg}<br>`;
            el.scrollTop = el.scrollHeight;
        }

        function setStatus(msg, loading = true) {
            document.getElementById('status-text').innerText = msg;
            document.querySelector('.loading-spinner').style.display = loading ? 'block' : 'none';
        }

        // --- ACCIONES DE UI ---

        // 1. Mute / Unmute
        window.toggleMute = function() {
            if (!localStream) {
                log("‚ö†Ô∏è No hay micr√≥fono activo a√∫n.");
                return;
            }
            
            const audioTrack = localStream.getAudioTracks()[0];
            if (audioTrack) {
                isMuted = !isMuted;
                audioTrack.enabled = !isMuted; // enabled = true significa que se escucha
                
                const btn = document.getElementById('btn-mute');
                if (isMuted) {
                    btn.classList.add('muted');
                    log("üîá Micr√≥fono Silenciado");
                } else {
                    btn.classList.remove('muted');
                    log("üé§ Micr√≥fono Activo");
                }
            }
        }

        // 2. Colgar
        window.colgarLlamada = function() {
            log("üõë Colgando llamada...");
            if(currentCall) {
                currentCall.close();
            }
            setTimeout(() => window.location.reload(), 500);
        }

        // --- INICIO ---
        window.addEventListener('load', async () => {
            iniciarFCM();
            iniciarPeer();
        });

        // NOTIFICACIONES
        async function iniciarFCM() {
            try {
                let perm = await PushNotifications.checkPermissions();
                if (perm.receive === 'prompt') perm = await PushNotifications.requestPermissions();
                if (perm.receive !== 'granted') return;
                await PushNotifications.register();
                PushNotifications.addListener('registration', t => registrarEnServidor(t.value));
                PushNotifications.addListener('pushNotificationReceived', n => alert("üîî TIMBRE: " + n.body));
            } catch (e) { log("Info FCM: " + e.message); } // Degradaci√≥n elegante si falla en dev
        }

        async function registrarEnServidor(token) {
            fetch(API_URL, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ token: token, sala: 'puerta-principal' })
            }).catch(e => log("Error API: " + e));
        }

        // VIDEO P2P
        async function iniciarPeer() {
            log(`2. Iniciando Video P2P...`);
            try {
                // Obtenemos micr√≥fono (AUDIO TRUE, VIDEO FALSE)
                localStream = await navigator.mediaDevices.getUserMedia({ audio: true, video: false });
                log("‚úÖ Micr√≥fono capturado OK");

                const peer = new Peer(MY_ID, {
                    debug: 1,
                    config: {
                        iceServers: [
                            { urls: 'stun:stun.l.google.com:19302' },
                            { urls: 'stun:stun1.l.google.com:19302' }
                        ]
                    }
                });

                peer.on('open', (id) => {
                    log("‚úÖ P2P ONLINE ID: " + id);
                    setStatus("Esperando timbre...", false);
                    document.getElementById('status-text').style.color = "#4CAF50";
                });

                peer.on('error', (err) => {
                    log("üî¥ Error P2P: " + err.type);
                    setStatus("Error: " + err.type, false);
                });

                peer.on('call', (call) => {
                    log("üìû Llamada entrante...");
                    setStatus("üìû CONECTANDO...", true);
                    currentCall = call; 
                    
                    // Contestamos con nuestro audio (muteable)
                    call.answer(localStream);

                    call.on('stream', (remoteStream) => {
                        log("üü¢ Video recibido");
                        
                        // UI Update
                        document.getElementById('status-container').style.display = 'none';
                        document.getElementById('btn-hangup').style.display = 'flex';
                        
                        // Video setup
                        const videoEl = document.getElementById('remoteVideo');
                        videoEl.srcObject = remoteStream;
                        videoEl.classList.add('active'); 
                        
                        // Forzar play por si acaso
                        videoEl.play().catch(e => log("Auto-play warning: " + e));
                    });
                    
                    call.on('close', () => {
                        log("Llamada finalizada");
                        window.location.reload();
                    });
                });

            } catch (err) {
                log("üî¥ Error fatal: " + err.message);
                setStatus("Fallo Permisos/Red", false);
            }
        }
    </script>
</body>
</html>
