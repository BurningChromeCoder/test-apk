<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Intercomunicador</title>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-messaging-compat.js"></script>

    <style>
        body { background: #000; color: #fff; font-family: sans-serif; display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100vh; margin: 0; padding: 20px; text-align: center;}
        .btn { background: #2ecc71; border: none; padding: 25px; border-radius: 50%; width: 100px; height: 100px; margin-top: 30px; cursor: pointer; animation: pulse 2s infinite; display: none; font-size: 40px;}
        .status { font-size: 18px; margin-bottom: 20px; color: #aaa; border: 1px solid #333; padding: 10px; border-radius: 10px; width: 100%;}
        .debug { color: yellow; font-size: 12px; margin-top: 20px; font-family: monospace; }
        @keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(46, 204, 113, 0.7); } 70% { box-shadow: 0 0 0 20px rgba(46, 204, 113, 0); } 100% { box-shadow: 0 0 0 0 rgba(46, 204, 113, 0); } }
    </style>
</head>
<body>
    <h3>üè† Monitor Puerta</h3>
    <div id="status" class="status">üü° Iniciando sistema...</div>
    <div id="debug" class="debug">Log de eventos...</div>
    <button id="btnAction" class="btn" onclick="contestar()">üìû</button>
    <audio id="remoteAudio" autoplay></audio>

    <script>
        // === 1. CONFIGURACI√ìN ===
        const MI_ID_FIJO = "puerta-admin-casa1"; 
        const logDiv = document.getElementById('debug');
        
        function log(msg) {
            console.log(msg);
            logDiv.innerHTML = msg + "<br>" + logDiv.innerHTML;
        }

        const firebaseConfig = {
          apiKey: "AIzaSyDMxrgcvTwO54m6NZjIGLTIGjKLYYYqF0E",
          authDomain: "puerta-c3a71.firebaseapp.com",
          projectId: "puerta-c3a71",
          storageBucket: "puerta-c3a71.firebasestorage.app",
          messagingSenderId: "830550601352",
          appId: "1:830550601352:web:f7125f76a1256aeb4db93d"
        };
        
        firebase.initializeApp(firebaseConfig);
        const messaging = firebase.messaging();

        // === 2. REGISTRO DE NOTIFICACIONES (INMEDIATO) ===
        async function iniciarNotificaciones() {
            log("üü° Solicitando permiso notificaciones...");
            try {
                const permission = await Notification.requestPermission();
                if (permission !== 'granted') {
                    log("‚ùå PERMISO DENEGADO. No sonar√°.");
                    alert("¬°Debes dar permiso de notificaciones para que suene!");
                    return;
                }

                log("üü° Obteniendo token FCM...");
                const token = await messaging.getToken({ vapidKey: 'BEeZjzTb9wf_k3aKd4W8MZF8veDWFr5rD9uT9zTApUZcICZ0YBnTrlCZ1HU99pM4lZr0AqHkDX5UHXo_swNe3FE' });
                
                if(token) {
                    log("‚úÖ Token obtenido. Registrando en servidor...");
                    // Registrar en tu Cloud Function
                    const resp = await fetch('https://us-central1-puerta-c3a71.cloudfunctions.net/registrarReceptor', {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({ token: token, sala: 'puerta-principal' })
                    });
                    
                    if(resp.ok) {
                        log("‚úÖ SISTEMA DE ALARMA LISTO.");
                        document.getElementById('status').innerText = "üü¢ Esperando timbre...";
                        document.getElementById('status').style.borderColor = "green";
                    } else {
                        log("‚ùå Error servidor: " + resp.status);
                    }
                } else {
                    log("‚ùå No se pudo obtener token.");
                }
            } catch(e) {
                log("‚ùå Error fatal notificaciones: " + e.message);
                alert("Error: " + e.message);
            }
        }

        // Iniciar registro YA MISMO
        iniciarNotificaciones();

        // Escuchar mensajes en primer plano
        messaging.onMessage((payload) => {
            log("üîî ¬°NOTIFICACI√ìN RECIBIDA EN FOREGROUND!");
            document.getElementById('status').innerText = "üîî ¬°TIMBRE SONANDO!";
            document.getElementById('btnAction').style.display = 'block';
            navigator.vibrate([500, 200, 500]); // Vibrar si est√° abierta
        });

        // === 3. PEERJS (AUDIO) ===
        const peer = new Peer(MI_ID_FIJO);
        let currentCall = null;

        peer.on('open', (id) => {
            log("‚úÖ Conexi√≥n Audio P2P Lista. ID: " + id);
        });

        peer.on('error', (err) => {
            log("‚ùå Error Audio P2P: " + err.type);
        });

        peer.on('call', (call) => {
            log("üìû Llamada entrante de audio...");
            currentCall = call;
            document.getElementById('status').innerText = "üîî ¬°TIMBRE SONANDO!";
            document.getElementById('btnAction').style.display = 'block';
        });

        async function contestar() {
            if(!currentCall) return;
            try {
                const localStream = await navigator.mediaDevices.getUserMedia({ audio: true });
                currentCall.answer(localStream);
                currentCall.on('stream', (remoteStream) => {
                    document.getElementById('remoteAudio').srcObject = remoteStream;
                    log("üîä AUDIO CONECTADO");
                    document.getElementById('status').innerText = "üîä HABLANDO";
                    document.getElementById('btnAction').style.display = 'none';
                });
            } catch (err) {
                alert("Error micr√≥fono: " + err);
            }
        }
    </script>
</body>
</html>
