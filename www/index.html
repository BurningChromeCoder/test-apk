<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Monitor Puerta P2P</title>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    
    <style>
        body { background: #000; color: #fff; font-family: sans-serif; margin: 0; display: flex; flex-direction: column; height: 100vh; overflow: hidden; }
        
        /* HEADER: Estado y Logo */
        .header { padding: 15px; background: #1f1f1f; border-bottom: 1px solid #333; display: flex; align-items: center; justify-content: space-between; }
        .status { font-size: 14px; font-weight: bold; }
        .status.ok { color: #4caf50; }
        .status.error { color: #f44336; }
        .status.waiting { color: #ffeb3b; }
        
        /* VIDEO: Ocupa el resto */
        #video-wrapper { flex-grow: 1; position: relative; background: #111; display: flex; align-items: center; justify-content: center; }
        video { width: 100%; height: 100%; object-fit: cover; }
        .placeholder { position: absolute; color: #555; font-size: 18px; text-align: center; }
        
        /* CONTROLES */
        .controls { position: absolute; bottom: 30px; width: 100%; display: flex; justify-content: center; gap: 20px; z-index: 10; display: none; }
        .btn { width: 70px; height: 70px; border-radius: 50%; border: none; font-size: 30px; cursor: pointer; display: flex; align-items: center; justify-content: center; box-shadow: 0 4px 10px rgba(0,0,0,0.5); }
        .btn-hangup { background: #f44336; color: white; }
    </style>
</head>
<body>

    <div class="header">
        <div id="status-text" class="status waiting">üü° Iniciando...</div>
        <img src="assets/icon.png" width="30" onerror="this.style.display='none'"> 
    </div>

    <div id="video-wrapper">
        <div id="msg-placeholder" class="placeholder">Esperando Timbre...</div>
        <video id="remoteVideo" autoplay playsinline></video>
        
        <div class="controls" id="controls">
            <button class="btn btn-hangup" onclick="colgar()">üìû</button>
        </div>
    </div>

    <script type="module">
        import { PushNotifications } from '@capacitor/push-notifications';
        import { Toast } from '@capacitor/toast';

        // --- CONFIGURACI√ìN ---
        const MY_ID = "puerta-admin-casa1"; 
        const API_URL = 'https://registrarreceptor-6rmawrifca-uc.a.run.app'; // Tu Cloud Function

        // Variables Globales
        let peer = null;
        let currentCall = null;
        let localStream = null;

        // --- 1. INICIO AUTOM√ÅTICO AL ABRIR APP ---
        window.addEventListener('load', async () => {
            log("üöÄ Iniciando App Monitor...");
            
            // A. Iniciar Notificaciones (Para que suene)
            await iniciarNotificaciones();
            
            // B. Iniciar PeerJS (Para escuchar la llamada)
            await iniciarPeer();
        });

        // --- L√ìGICA DE NOTIFICACIONES (FCM) ---
        async function iniciarNotificaciones() {
            try {
                let perm = await PushNotifications.checkPermissions();
                if (perm.receive === 'prompt') perm = await PushNotifications.requestPermissions();
                
                if (perm.receive === 'granted') {
                    await PushNotifications.register();
                    addNotificationListeners();
                } else {
                    log("üî¥ Sin permiso de notificaciones");
                }
            } catch (e) { log("Error FCM: " + e.message); }
        }

        async function addNotificationListeners() {
            PushNotifications.addListener('registration', async token => {
                log("Token FCM OK. Enviando a servidor...");
                // Registrar en servidor para recibir el "Ding Dong"
                fetch(API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ token: token.value, sala: 'puerta-principal' })
                }).catch(e => log("Error enviando token: " + e));
            });
            
            PushNotifications.addListener('pushNotificationReceived', notification => {
                Toast.show({ text: 'üîî ¬°TIMBRE! Alguien en la puerta', duration: 'long' });
            });
        }

        // --- L√ìGICA P2P (VIDEOLLAMADA) ---
        async function iniciarPeer() {
            setStatus("‚è≥ Conectando P2P...", "waiting");
            
            try {
                // Pedir permiso de micr√≥fono al inicio
                localStream = await navigator.mediaDevices.getUserMedia({ audio: true, video: false });
            } catch (err) {
                log("üî¥ Error Micr√≥fono: " + err.message);
                alert("Necesitamos micr√≥fono para contestar.");
                return;
            }

            peer = new Peer(MY_ID, { debug: 1 });

            peer.on('open', (id) => {
                setStatus("‚úÖ LISTO: Esperando llamada", "ok");
                log("Mi ID P2P: " + id);
            });

            peer.on('call', (call) => {
                log("üìû ¬°LLAMADA ENTRANTE!");
                setStatus("üîî CONTESTANDO...", "waiting");
                
                // Contestamos autom√°ticamente
                call.answer(localStream);
                currentCall = call;

                call.on('stream', (remoteStream) => {
                    document.getElementById('msg-placeholder').style.display = 'none';
                    document.getElementById('remoteVideo').srcObject = remoteStream;
                    document.getElementById('controls').style.display = 'flex';
                    setStatus("üü¢ EN L√çNEA: Visitante", "ok");
                });

                call.on('close', () => resetUI());
                call.on('error', () => resetUI());
            });

            peer.on('error', (err) => {
                log("Error Peer: " + err.type);
                if(err.type === 'unavailable-id') {
                    setStatus("‚ö†Ô∏è ID en uso (Reinicia App)", "error");
                } else {
                    setStatus("üî¥ Desconectado", "error");
                    // Reintentar en 5 segundos
                    setTimeout(iniciarPeer, 5000);
                }
            });
            
            peer.on('disconnected', () => {
                 setStatus("‚ö†Ô∏è Desconectado. Reconectando...", "waiting");
                 peer.reconnect();
            });
        }

        // Funciones Auxiliares
        window.colgar = function() {
            if (currentCall) currentCall.close();
            resetUI();
        }

        function resetUI() {
            document.getElementById('remoteVideo').srcObject = null;
            document.getElementById('msg-placeholder').style.display = 'block';
            document.getElementById('controls').style.display = 'none';
            setStatus("‚úÖ LISTO: Esperando llamada", "ok");
            currentCall = null;
        }

        function setStatus(msg, type) {
            const el = document.getElementById('status-text');
            el.innerText = msg;
            el.className = "status " + type;
        }
        
        function log(msg) { console.log(msg); }
    </script>
</body>
</html>
