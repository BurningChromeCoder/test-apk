<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Monitor Puerta V3</title>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    
    <style>
        /* --- ESTILOS MODERNOS --- */
        body { 
            background: #000; 
            color: #fff; 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; 
            margin: 0; 
            display: flex; 
            flex-direction: column; 
            height: 100vh; 
            overflow: hidden;
        }
        
        /* CONSOLA DE LOGS (MÃ¡s discreta) */
        #console-log {
            background: rgba(0,0,0,0.8); 
            color: #0f0; 
            padding: 10px; 
            height: 60px;
            overflow-y: scroll; 
            border-bottom: 1px solid #333; 
            font-size: 10px; 
            font-family: monospace;
            position: relative;
            z-index: 5;
        }

        /* CONTENEDOR DE VIDEO */
        #video-wrapper { 
            flex-grow: 1; 
            position: relative; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            background: #121212; 
            overflow: hidden;
        }

        /* --- FIX ICONO PLAY GIGANTE --- */
        video { 
            width: 100%; 
            height: 100%; 
            object-fit: cover; 
            display: none; 
        }
        /* Esto oculta los controles nativos de Android WebView */
        video::-webkit-media-controls { display:none !important; }
        video::-webkit-media-controls-start-playback-button { display: none !important; -webkit-appearance: none; }
        
        video.active { display: block; }

        .status-big { 
            position: absolute; 
            font-size: 18px; 
            color: #ffeb3b; 
            text-align: center; 
            z-index: 10;
            background: rgba(0,0,0,0.5);
            padding: 10px 20px;
            border-radius: 20px;
        }
        
        /* --- CONTROLES FLOTANTES MODERNOS (Glassmorphism) --- */
        .controls-layer {
            position: absolute; 
            bottom: 40px; 
            left: 50%;
            transform: translateX(-50%);
            width: auto;
            display: flex; 
            justify-content: center; 
            gap: 20px; 
            z-index: 20;
            background: rgba(30, 30, 30, 0.8);
            backdrop-filter: blur(10px);
            padding: 15px 30px;
            border-radius: 40px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.5);
            border: 1px solid rgba(255,255,255,0.1);
        }

        .btn { 
            width: 60px; 
            height: 60px; 
            border: none; 
            border-radius: 50%; 
            font-size: 24px; 
            cursor: pointer; 
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            transition: transform 0.1s, background 0.2s;
        }
        
        .btn:active { transform: scale(0.9); }

        .btn-reload { background: #34495e; }
        .btn-hangup { background: #e74c3c; display: none; } /* Rojo */
        
        /* BotÃ³n Mute */
        .btn-mute { background: #f1c40f; color: #000; } /* Amarillo */
        .btn-mute.muted { background: #d32f2f; color: #fff; } /* Rojo oscuro al mutear */

    </style>
</head>
<body>

    <div id="console-log">
        > Iniciando Sistema V3 (con STUN)...<br>
    </div>

    <div id="video-wrapper">
        <div id="status-text" class="status-big">ðŸŸ¡ Iniciando servicios...</div>
        <video id="remoteVideo" autoplay playsinline webkit-playsinline></video>
        
        <div class="controls-layer">
            <button id="btn-mute" class="btn btn-mute" onclick="toggleMute()">ðŸŽ¤</button>
            
            <button id="btn-hangup" class="btn btn-hangup" onclick="colgarLlamada()">ðŸ“ž</button>
            <button class="btn btn-reload" onclick="window.location.reload()">ðŸ”„</button>
        </div>
    </div>

    <script type="module">
        import { PushNotifications } from '@capacitor/push-notifications';
        
        // --- CONFIGURACIÃ“N ---
        const MY_ID = "puerta-admin-v2"; 
        const API_URL = 'https://registrarreceptor-6rmawrifca-uc.a.run.app';
        
        let currentCall = null;
        let localStream = null; // VARIABLE GLOBAL PARA PODER MUTEAR
        let isMuted = false;

        function log(msg) {
            console.log(msg);
            const el = document.getElementById('console-log');
            el.innerHTML += `> ${msg}<br>`;
            el.scrollTop = el.scrollHeight;
        }

        function setStatus(msg) {
            document.getElementById('status-text').innerText = msg;
        }

        // --- ACCIONES DE UI ---
        
        // 1. LÃ³gica de Mute (NUEVA)
        window.toggleMute = function() {
            if(!localStream) {
                log("âš ï¸ AÃºn no hay audio activo");
                return;
            }
            const audioTrack = localStream.getAudioTracks()[0];
            if (audioTrack) {
                isMuted = !isMuted;
                audioTrack.enabled = !isMuted; // enabled = true es micrÃ³fono abierto
                
                const btn = document.getElementById('btn-mute');
                if (isMuted) {
                    btn.classList.add('muted');
                    btn.innerText = "ðŸ”‡";
                    log("ðŸ”‡ MicrÃ³fono silenciado");
                } else {
                    btn.classList.remove('muted');
                    btn.innerText = "ðŸŽ¤";
                    log("ðŸŽ¤ MicrÃ³fono activo");
                }
            }
        }

        window.colgarLlamada = function() {
            log("ðŸ›‘ Colgando llamada...");
            if(currentCall) {
                currentCall.close();
            }
            // Recargamos para limpiar cualquier error de video o memoria
            setTimeout(() => window.location.reload(), 500);
        }

        // --- INICIO ---
        window.addEventListener('load', async () => {
            iniciarFCM();
            iniciarPeer();
        });

        // 1. NOTIFICACIONES
        async function iniciarFCM() {
            try {
                let perm = await PushNotifications.checkPermissions();
                if (perm.receive === 'prompt') perm = await PushNotifications.requestPermissions();
                if (perm.receive !== 'granted') return;
                await PushNotifications.register();
                PushNotifications.addListener('registration', t => registrarEnServidor(t.value));
                PushNotifications.addListener('pushNotificationReceived', n => alert("ðŸ”” TIMBRE: " + n.body));
            } catch (e) { log("Error FCM: " + e.message); }
        }

        async function registrarEnServidor(token) {
            fetch(API_URL, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ token: token, sala: 'puerta-principal' })
            }).catch(e => log("Error API: " + e));
        }

        // 2. VIDEO P2P CON STUN (Mantenemos TU lista de servidores original)
        async function iniciarPeer() {
            log(`2. Iniciando Video P2P...`);
            try {
                // Pedimos permiso de micrÃ³fono y lo guardamos en la variable GLOBAL
                localStream = await navigator.mediaDevices.getUserMedia({ audio: true, video: false });
                log("âœ… MicrÃ³fono activo");

                // ConfiguraciÃ³n con servidores STUN (Tu lista original que funciona bien)
                const peer = new Peer(MY_ID, {
                    debug: 1,
                    config: {
                        iceServers: [
                            { urls: 'stun:stun.l.google.com:19302' },
                            { urls: 'stun:stun1.l.google.com:19302' },
                            { urls: 'stun:stun2.l.google.com:19302' },
                            { urls: 'stun:stun3.l.google.com:19302' },
                            { urls: 'stun:stun4.l.google.com:19302' }
                        ]
                    }
                });

                peer.on('open', (id) => {
                    log("âœ… P2P LISTO. Esperando...");
                    setStatus("âœ… LISTO: Esperando Timbre");
                    document.getElementById('status-text').style.color = "#4CAF50";
                });

                peer.on('error', (err) => {
                    log("ðŸ”´ Error P2P: " + err.type);
                    setStatus("Error: " + err.type);
                });

                peer.on('call', (call) => {
                    log("ðŸ“ž Llamada entrante...");
                    setStatus("ðŸ“ž CONECTANDO...");
                    currentCall = call; 
                    
                    // Contestamos enviando nuestro audio GLOBAL (para poder mutearlo)
                    call.answer(localStream);

                    call.on('stream', (remoteStream) => {
                        log("ðŸŸ¢ Video recibido");
                        
                        // 1. Ocultamos el texto de estado
                        document.getElementById('status-text').style.display = 'none';
                        
                        // 2. Mostramos el video y ACTIVAMOS EL CSS HACK para quitar el icono
                        const videoEl = document.getElementById('remoteVideo');
                        videoEl.srcObject = remoteStream;
                        videoEl.classList.add('active'); 
                        
                        // 3. Mostramos el botÃ³n de colgar (Flex para mantener alineaciÃ³n)
                        document.getElementById('btn-hangup').style.display = 'flex';
                    });
                    
                    call.on('close', () => {
                        log("Llamada finalizada");
                        window.location.reload();
                    });
                });

            } catch (err) {
                log("ðŸ”´ Error fatal: " + err.message);
                setStatus("Fallo: " + err.message);
            }
        }
    </script>
</body>
</html>
