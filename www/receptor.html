<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MiPuerta Receptor P2P</title>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    
    <style>
        body { background: #000; color: #fff; font-family: sans-serif; margin: 0; display: flex; flex-direction: column; height: 100vh; overflow: hidden; }
        
        /* Video ocupa toda la pantalla */
        #video-container { position: relative; flex-grow: 1; display: flex; justify-content: center; align-items: center; background: #111; }
        video { width: 100%; height: 100%; object-fit: cover; }
        
        /* Controles flotantes */
        .controls { position: absolute; bottom: 30px; left: 0; width: 100%; display: flex; justify-content: center; gap: 20px; z-index: 10; }
        .btn { width: 60px; height: 60px; border-radius: 50%; border: none; font-size: 24px; cursor: pointer; display: flex; align-items: center; justify-content: center; box-shadow: 0 4px 10px rgba(0,0,0,0.5); }
        .btn-hangup { background: #f44336; color: white; }
        .btn-answer { background: #4caf50; color: white; }
        
        /* Estado */
        .status-bar { padding: 10px; text-align: center; background: #222; font-size: 14px; }
        .waiting { color: #ffeb3b; }
        .connected { color: #4caf50; font-weight: bold; }
    </style>
</head>
<body>

    <div id="status" class="status-bar waiting">Iniciando sistema P2P...</div>

    <div id="video-container">
        <video id="remoteVideo" autoplay playsinline></video>
    </div>

    <div class="controls" id="controls" style="display:none;">
        <button class="btn btn-hangup" onclick="colgar()">üìû</button>
    </div>

    <script>
        // --- CONFIGURACI√ìN P2P ---
        // ESTE ID DEBE SER EXACTAMENTE EL MISMO QUE EN 'visitante.html'
        const MY_ID = "puerta-admin-casa1"; 
        
        let peer = null;
        let currentCall = null;
        let localStream = null;

        // 1. Inicializar al cargar
        window.addEventListener('load', async () => {
            await iniciarPeer();
        });

        async function iniciarPeer() {
            setStatus("‚è≥ Conectando a la red P2P...");

            try {
                // Obtenemos micr√≥fono del celular para poder hablarle al visitante
                // (Si quieres video tambi√©n, cambia video: false a video: true)
                localStream = await navigator.mediaDevices.getUserMedia({ audio: true, video: false });
            } catch (err) {
                console.error("No se pudo obtener micr√≥fono", err);
                setStatus("‚ùå Error: Falta permiso de micr√≥fono");
                return;
            }

            // Creamos la identidad del receptor
            peer = new Peer(MY_ID, {
                debug: 2
            });

            // A: Conexi√≥n exitosa con el servidor de se√±alizaci√≥n
            peer.on('open', (id) => {
                console.log('Mi ID es: ' + id);
                setStatus("‚úÖ LISTO: Esperando llamada...");
            });

            // B: Alguien est√° llamando (El visitante toc√≥ el timbre)
            peer.on('call', (call) => {
                console.log("üìû Llamada entrante de:", call.peer);
                setStatus("üîî ¬°LLAMADA ENTRANTE!");
                
                // Contestamos autom√°ticamente enviando nuestro audio
                call.answer(localStream); 
                currentCall = call;

                // Cuando llega el video del visitante
                call.on('stream', (remoteStream) => {
                    console.log("Video recibido");
                    const videoElem = document.getElementById('remoteVideo');
                    videoElem.srcObject = remoteStream;
                    setStatus("üü¢ CONECTADO: Hablando con puerta");
                    document.getElementById('controls').style.display = 'flex';
                });

                call.on('close', () => {
                   resetLlamada();
                });
            });

            // C: Manejo de errores
            peer.on('error', (err) => {
                console.error(err);
                if (err.type === 'unavailable-id') {
                    setStatus("‚ö†Ô∏è Error: Ya hay otra app abierta con este ID");
                } else {
                    setStatus("‚ùå Error de red: " + err.type);
                }
            });
        }

        function colgar() {
            if (currentCall) {
                currentCall.close();
            }
            resetLlamada();
        }

        function resetLlamada() {
            document.getElementById('remoteVideo').srcObject = null;
            document.getElementById('controls').style.display = 'none';
            setStatus("‚úÖ LISTO: Esperando llamada...");
            currentCall = null;
        }

        function setStatus(msg) {
            document.getElementById('status').innerText = msg;
        }
    </script>
</body>
</html>
